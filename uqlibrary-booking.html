<link rel="import" href="../uqlibrary-elements/0.5.1/lib/vulcanized.html">
<link rel="import" href="uqlibrary-rooms-list.html">
<link rel="import" href="uqlibrary-fbs-filter-form.html">
<link rel="import" href="uqlibrary-fbs-booking-form.html">
<link rel="import" href="uqlibrary-fbs-booking-display.html">

<polymer-element name="uqlibrary-booking">

  <template>
    <link rel="stylesheet" href="uqlibrary-booking.css">

    <uqlibrary-ga id="ga" appName="FBS"></uqlibrary-ga>

    <uqlibrary-api-account id="account"></uqlibrary-api-account>
    <uqlibrary-api-account-bookings id="bookings"></uqlibrary-api-account-bookings>
    <uqlibrary-api-facilities-availability id="facilities"></uqlibrary-api-facilities-availability>

    <core-drawer-panel id="drawerPanel" drawerWidth="85%" responsiveWidth="9999px">
      <core-header-panel drawer id="drawer">
        <uqlibrary-menu account="{{user}}"></uqlibrary-menu>
      </core-header-panel>

      <core-header-panel main id="main">
        <core-toolbar>
          <paper-icon-button id="toolBarLeftButton"
                             hidden?="{{!pageToolbar.leftButton.icon}}"
                             icon="{{pageToolbar.leftButton.icon ? pageToolbar.leftButton.icon : ''}}"
                             on-tap="{{doTransition}}"></paper-icon-button>
          <span flex id="toolbar-page-title">{{pageToolbar.title}}</span>
          <paper-icon-button id="toolBarRightButton"
                             on-tap="{{doTransition}}"
                             hidden?="{{!pageToolbar.rightButton.icon}}"
                             icon="{{pageToolbar.rightButton.icon ? pageToolbar.rightButton.icon : ''}}"></paper-icon-button>
        </core-toolbar>

        <div id="content">

          <core-animated-pages id="pages"
                               transitions="{{transition}}"
                                on-core-animated-pages-transition-prepare="{{transitionPrepareHandler}}"
                                on-core-animated-pages-transition-end="{{transitionEndHandler}}"
            >
            <section id="myBookings">
              <template if="{{events.length}}">
                <uqlibrary-timeline events="{{events}}" on-event-selected="{{bookingSelected}}"></uqlibrary-timeline>
              </template>
              <paper-toast id="myBookingsInfoToast" flex></paper-toast>
              <paper-fab hero-id="filterForm"
                         hero?="{{transition === 'hero-transition'}}"
                         id="addBookingButton"
                         icon="add"
                         class="action"
                         hidden?="{{transitioning}}"
                         on-tap="{{doTransition}}"></paper-fab>
            </section>

            <section id="filterForm">

              <div horizontal center-justified layout >
                <uqlibrary-fbs-filter-form id="fbsFilterForm"
                                           hero-id="filterForm"
                                           on-filter-form-submitted="{{filterFormSubmitted}}"
                                           hero?="{{transition === 'hero-transition'}}"
                                           formData="{{filterFormData}}" selectedValues={{filterFormSelectedValues}}></uqlibrary-fbs-filter-form>
                </div>
            </section>

            <section id="results">
            </section>

            <section id="bookingFormSection">
              <uqlibrary-fbs-booking-form id="bookingForm" on-booking-date-changed="{{searchDateChanged}}" on-booking-created="{{bookingCreated}}"></uqlibrary-fbs-booking-form>
            </section>

            <section id="bookingDetailsSection">
              <uqlibrary-fbs-booking-display id="bookingDetails" on-booking-deleted="{{bookingDeleted}}"></uqlibrary-fbs-booking-display>
            </section>

          </core-animated-pages>

        </div>

      </core-header-panel>

    </core-drawer-panel>

  </template>

  <script>
    (function() {
      Polymer('uqlibrary-booking', {

         currentPage: 'myBookings',
        transitioning: false,

        created: function () {
          this.facilities = [];
          this.rooms = [];
          this.user = {};
          this.events = [];
        },

        ready: function() {
          var that = this;

          this.pageTransitions = {
            addBookingButton: {
              transition: 'hero-transition',
              destination: 'filterForm',
              action: 'showFilterForm'
            }
          };

          this.$.ga.addPageView(this.currentPage);
          this.loadFilterFormData();

          this.$.account.addEventListener('uqlibrary-api-account-loaded', function(e) {
            if (e.detail.hasSession) {
              that.user = e.detail;

              that.$.bookingForm.authTokenValue = this.getCookie("UQLID");
              that.$.bookingDetails.authTokenValue = this.getCookie("UQLID");

            } else {
              // Not logged in
              // TODO: Redirect to login
            }
          });
          this.$.account.get();

          this.$.facilities.addEventListener('uqlibrary-api-facilities-availability-loaded', function(e) {
            that.facilities = e.detail;

            if (that.facilities.length > 0) {
              that.buildFilterFormDataFacilitiesArray();

              switch(that.currentPage) {
                case 'myBookings':
                  that.showMyBookings();
                  break;
                case 'bookingFormSection':
                  that.$.bookingForm.roomDetails = that.rooms[that.$.bookingForm.roomDetails.id];
                  break;
              }
            }
          });
          this.$.facilities.get();
        },

        togglePanel: function () {
          this.$.drawerPanel.togglePanel();
        },

        showInfoToast: function(toast, text) {
          toast.text = text;
          toast.show();
        },

        doTransition: function (e, data, sender) {
          var p = this.pageTransitions[sender.id];
          if (p.transition) {
            this.transition = p.transition;
          }
          if (p.destination) {
            this.$.pages.selectedItem = this.$[p.destination];
            this.currentPage = p.destination;
          }

          if (p.action) {
            if (p.destination) {
              this.$.ga.addPageView(p.destination);
            } else {
              this.$.ga.addEvent(p.action);
            }
            this[p.action](data);
          }
        },

        transitionPrepareHandler: function(e) {
          this.transitioning = true;
          this.fire('core-signal', {name: "transition-prepare"});
        },

        transitionEndHandler: function(e) {
          this.transitioning = false;
          if(e.target.selectedItem.id == 'results') {
            this.createResultsList();
          }
          this.fire('core-signal', {name: "transition-end"});
        },

        showMyBookings: function() {
          var that = this;

          this.pageTransitions.toolBarLeftButton = {
            action: 'togglePanel'
          };

          this.pageToolbar = {
            leftButton: {icon:'menu'},
            title: 'My bookings'
          };

          this.pageTransitions.bookingDetails = {
            transition: 'slide-from-right',
            destination: 'bookingDetailsSection',
            action: 'showBookingDetails'
          };

          this.$.bookings.addEventListener('uqlibrary-api-account-bookings-loaded', function(e) {
            var bookings = e.detail;
            if (bookings.length > 0) {
              var events = [];
              bookings.forEach(function (b) {
                events.push({
                  id: b.id,
                  startDate: new Date(b.from * 1000),
                  endDate: new Date(b.to * 1000),
                  title: b.resource.title,
                  scheduleid: b.resource.id,
                  machid: b.resource.machid
                });
              });
              that.events = events;
          }
          });

          this.$.bookings.get();
        },

        showFilterForm: function() {
          this.pageTransitions.toolBarLeftButton = {
            transition: 'slide-from-right',
            destination: 'myBookings',
            action: 'showMyBookings'
          };

          this.pageTransitions.toolBarRightButton = {
            transition: 'slide-from-right',
            action: 'submitFilterForm'
          };

          this.pageTransitions.fbsFilterForm = {
              transition: 'slide-from-right',
              destination: 'results',
              action: 'showResultsPage'
          };

          this.pageToolbar = {
            leftButton: {icon:'arrow-back'},
            rightButton: {icon:'check'},
            title: 'Find a room'
          };

          this.addEventListener('selected-date-changed', function(e) {
            var _newDate = new Date(e.detail.date);
            this.formData = e.detail.formData;

            this.$.facilities.get({date: moment(_newDate).format('DD-MM-YYYY')});
          });

          this.addEventListener('selected-values-changed', function(e) {
            this.formData = e.detail.formData;
            this.getFilteredRooms();
            this.$.fbsFilterForm.setResultsText(this.searchResults.length + ' room(s) found')
          });

        },

        submitFilterForm: function() {
          this.$.fbsFilterForm.fire('submit-form');
        },

        filterFormSubmitted: function(e, data, sender) {
          this.formData = e.detail.formData;
          this.getFilteredRooms();
          if(this.searchResults.length == 0) {
            return false;
          }
          else {
            this.doTransition(e, data, sender);
          }
        },

        showResultsPage: function() {
          this.pageTransitions.toolBarLeftButton = {
            transition: 'slide-from-right',
            destination: 'filterForm',
            action: 'showFilterForm'
          };

          this.pageToolbar = {
            leftButton: {icon:'arrow-back'},
            title: 'Select a room'
          };

          this.pageTransitions.resultsList = {
            transition: 'slide-from-right',
            destination: 'bookingFormSection',
            action: 'showBookingForm'
          }

          this.addEventListener('room-selected', this.roomSelected);

        },

        createResultsList: function() {

          // Remove existing rooms list
          var currentList = this.$.results.querySelector('uqlibrary-rooms-list');
          if (currentList) {
            currentList.parentNode.removeChild(currentList);
          }

          var roomsList = document.createElement('uqlibrary-rooms-list');
          roomsList.setAttribute('id', 'resultsList');
          roomsList.setData(this.searchResults);

          var container = document.querySelector("#main /deep/ #mainContainer");
          if(container && container.offsetHeight) {
            roomsList.setAttribute('style', "height: " + container.offsetHeight +'px;');
          }
          this.$.results.appendChild(roomsList);

          // Set core-list height after loading items
          var list = document.querySelector('uqlibrary-rooms-list /deep/ core-list');
          if(container && container.offsetHeight) {
            list.setAttribute('style', list.getAttribute('style') + "; height: " + container.offsetHeight +'px;');
          }
        },

        roomSelected: function(event, data, sender) {
          this.doTransition(event, event.detail.item, { id: 'resultsList' });
        },

        showBookingDetails : function (data) {

          this.$.bookingDetails.roomDetails = this.rooms[data.machid];
          this.$.bookingDetails.bookingDetails = data;

          this.pageToolbar = {
            leftButton: { icon:'arrow-back' },
            title: 'Booking details'
          };

          this.pageTransitions.toolBarLeftButton = {
            transition: 'slide-from-right',
            destination: 'myBookings',
            action: 'showMyBookings'
          };
        },

        showBookingForm: function(data) {
          //setup booking form page
          this.pageTransitions.bookingForm = {
            transition: 'slide-from-right',
            destination: 'myBookings',
            action: 'showMyBookings'
          }

          this.pageTransitions.toolBarLeftButton = {
            transition: 'slide-from-right',
            destination: 'results',
            action: 'showResultsPage'
          };

          this.pageTransitions.toolBarRightButton = {
            transition: 'slide-from-right',
            action: 'submitBookingForm'
          };

          this.pageToolbar = {
            leftButton: { icon:'arrow-back' },
            rightButton: { icon:'check' },
            title: 'Book a room'
          };

          //setup booking form properties
          this.$.bookingForm.roomDetails = data;
          var searchDate = this.formData.searchDate ?
                  this.formData.searchDate : new Date();
          this.$.bookingForm.searchDate = searchDate;
          this.$.bookingForm.searchDuration = this.formData.duration;
          //TODO: maybe this should be a global setting?
          this.$.bookingForm.maxBookingDate = new Date((new Date().getTime()) + 7 * 24 * 60 * 60 * 1000);

        },

        submitBookingForm: function() {
          this.$.bookingForm.fire('submit-form');
        },

        bookingSelected: function(e, data, sender){
          //transition to booking details
          this.doTransition(e, data, {id: 'bookingDetails'});
        },

        bookingDeleted: function(e, data, sender){
          this.$.ga.addEvent('bookingDeleted');

          this.$.bookings.get();

          //Transition to timeline page
          this.doTransition(e, data, {id: 'toolBarLeftButton'});

          //Show toast that event was deleted after the transition is done
          var that = this;
          setTimeout(function(){
            that.showInfoToast(that.$.myBookingsInfoToast, "Your booking was deleted.");
          }, 2000, that);
        },

        bookingCreated: function(e, data, sender) {
          this.$.ga.addEvent('bookingCreated');

          // add new booking details to events on timeline
          this.$.bookings.get();

          // transition to timeline
          this.doTransition(e, data, {id: 'bookingForm'});
        },


        searchDateChanged: function(e, data, sender) {
          this.$.facilities.get({date: moment(data.searchDate).format('DD-MM-YYYY')});
        },

        buildFilterFormDataFacilitiesArray: function() {
          var _facilities = {};

          for(var i = 0; i < this.facilities.length; i++) {
            for(var j =0; j < this.facilities[i].resources.length; j++){
              for(var k =0; k < this.facilities[i].resources[j].facilities.length; k++){
                var _facility = this.facilities[i].resources[j].facilities[k];

                if (!_facilities[_facility.campus]) {

                  _facilities[_facility.campus] = {
                    id: _facility.campus,
                    title: _facility.campus,
                    buildingsObjects: {}
                  };
                }

                if(!_facilities[_facility.campus].buildingsObjects[_facility.building]) {
                  _facilities[_facility.campus].buildingsObjects[_facility.building] = {

                    id: _facility.building,
                    title: _facility.building,
                    rooms: []

                  };
                }
                _facilities[_facility.campus].buildingsObjects[_facility.building].rooms.push(
                  {
                    id: _facility.id,
                    title: _facility.title,
                    capacity: _facility.capacity,
                    maxtime: _facility.maxtime,
                    mintime: _facility.mintime
                  });

                var buildingImageName = _facility.building.replace(/\s/g, '_').replace(/\W/g, '').toLowerCase();
                var campusImageName = _facility.campus.replace(/\s/g, '_').replace(/\W/g, '').toLowerCase();

                this.rooms[_facility.id] = {
                    id: _facility.id,
                    scheduleid: _facility.scheduleid,
                    title: _facility.title,
                    campus: _facility.campus,
                    building: _facility.building,
                    location: _facility.location,
                    capacity: _facility.capacity,
                    maxtime: _facility.maxtime,
                    mintime: _facility.mintime,
                    bookings: _facility.bookings,
                    available_from: this.facilities[i].resources[j].schedule.available_from,
                    available_to: this.facilities[i].resources[j].schedule.available_to,
                    url: _facility.url,
                    notes: _facility.notes,
                    next_available_time: null,
                    next_available_time_text: '',
                    time_span: this.facilities[i].resources[j].schedule['time_span'],
                    image : campusImageName + '/' + buildingImageName + '_thumb' + '.jpg',
                    imageLarge : campusImageName + '/' + buildingImageName + '.jpg'
                };
              }
            }
          }
          this.filterFormData.facilities = [];
          var _campusKeys = Object.keys(_facilities);
          for(var i = 0; i < _campusKeys.length; i++) {

            var _buildingsKeys = Object.keys(_facilities[_campusKeys[i]].buildingsObjects);
            _facilities[_campusKeys[i]].buildings = [];
            for(var j = 0; j < _buildingsKeys.length; j++) {
              _facilities[_campusKeys[i]].buildings.push(_facilities[_campusKeys[i]].buildingsObjects[_buildingsKeys[j]]);
            }
            delete(_facilities[_campusKeys[i]].buildingsObjects);
            this.filterFormData.facilities.push(_facilities[_campusKeys[i]]);
          }

          // Sort array based on number of available buildings
          this.filterFormData.facilities.sort(function(a, b){return b.buildings.length - a.buildings.length });

        },

        getFilteredRooms: function() {

          this.searchResults = [];
          /*if (this.formData.room && this.rooms[this.formData.room]) {
            this.searchResults.push(this.rooms[this.formData.room]);
            return;
          }*/

          var _keys = Object.keys(this.rooms);

          if (_keys.length > 0) {
            for(var i = 0; i < _keys.length; i++) {
              var _room = this.rooms[_keys[i]];

              var _add = true;
              if(_add && this.formData.campus) {
                if(_room.campus != this.formData.campus) {
                  _add = false;
                }
              }
              if(_add && this.formData.building) {
                if(_room.building != this.formData.building) {
                  _add = false;
                }
              }
              if(_add && this.formData.room) {
                if(_room.id != this.formData.room) {
                  _add = false;
                }

              }

              if(_add && this.formData.searchDate) {

                _room.next_available_time = null;
                _room.next_available_time_text = '';
                var _startTimestamp = 0;
                if(this.formData.searchDate > new Date()){
                  _startTimestamp = this.roundTimestamp('up', moment(this.formData.searchDate).unix(), _room.time_span);
                }
                else {
                  _startTimestamp = this.roundTimestamp('down', moment().unix(), _room.time_span);
                }
                if(this.formData.searchDate >= _startTimestamp) {
                  _room.next_available_time = this.getRoomFirstAvailableTime(_room, _startTimestamp, this.formData.duration);
                  if(_room.next_available_time) {
                    var _time = moment.unix(_room.next_available_time);
                    _room.next_available_time_text =  _time.format("h:mm a") + ' - ' + _time.add(this.formData.duration, 'minutes').format("h:mm a") + ', ' + _time.format("DD/MM/YYYY");
                  }
                }
                if(!_room.next_available_time) {
                  _add = false;
                }
              }

              if(this.formData.capacity && _room.capacity) {
                if(_room.capacity < this.formData.capacity) {
                  _add = false;
                }
              }

              if (_add) {
                this.searchResults.push(_room);
              }

            }

          }
          if(this.searchResults.length > 0) {
            this.searchResults.sort(function(a, b){return a.next_available_time - b.next_available_time });
          }
        },

        getRoomFirstAvailableTime: function(room, startTimestamp, duration) {

          // first build available time slots
          var _slots = [];
          var firstAvailableTime = 0;
          if(room.bookings.length > 0) {
            var _begin = room.available_from;

            for(var i = 0; i < room.bookings.length; i++) {
              var _booking = room.bookings[i];
              if(_begin != _booking.from){
                _slots.push({from: _begin, to: _booking.from});
              }
                _begin = _booking.to;
            }
            if(_begin != room.available_to) {
              _slots.push({from: _begin, to: room.available_to});
            }
          }
          else {
            _slots.push({from: room.available_from, to: room.available_to});
          }

          if(_slots.length > 0) {
            for(var i = 0; i < _slots.length; i++) {
              var _slot = _slots[i];
              var _endTimestamp = startTimestamp + duration * 60;
              if(_slot.to < startTimestamp) {
                continue;
              }
              if(startTimestamp >= _slot.from && _endTimestamp <= _slot.to) {
                firstAvailableTime = startTimestamp;

                break;
                // available time
              }
              if(_endTimestamp <= _slot.to && _slot.to >= (_slot.from + duration * 60)){
                firstAvailableTime = _slot.from;
                break;
              }

            }
          }
          return (firstAvailableTime > 0 ? firstAvailableTime : false);


        },

        roundTimestamp: function(direction, timestamp, timeSpan) {
          if(timestamp % (timeSpan * 60) == 0) {
            return timestamp;
          }
          if(direction == 'up') {
            return (timestamp - (timestamp % (timeSpan * 60))  + (timeSpan * 60) );
          }
          else {
            return (timestamp - (timestamp % (timeSpan * 60)));
          }
        },

        // MOCK DATA
        loadFilterFormData: function() {
          this.filterFormData = {};
          this.filterFormData.dates = [];
          var today = new Date();
          for(var i = 0; i < 7; i++) {
            this.filterFormData.dates.push({
              date: new Date().setDate(today.getDate() + i)
            });
          }
        }

      });
    })();
  </script>

</polymer-element>
