<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../core-animated-pages/core-animated-pages.html">
<link rel="import" href="../core-animated-pages/transitions/slide-from-right.html">
<link rel="import" href="../core-animated-pages/transitions/hero-transition.html">
<link rel="import" href="../core-animated-pages/transitions/cross-fade.html">

<link rel="import" href="../core-drawer-panel/core-drawer-panel.html">
<link rel="import" href="../core-header-panel/core-header-panel.html">
<link rel="import" href="../core-toolbar/core-toolbar.html">
<link rel="import" href="../core-menu/core-menu.html">
<link rel="import" href="../core-icons/core-icons.html">
<link rel="import" href="../core-icons/social-icons.html">
<link rel="import" href="../core-icons/av-icons.html">

<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-fab/paper-fab.html">

<link rel="import" href="../uqlibrary-timeline/uqlibrary-timeline.html">
<link rel="import" href="../uqlibrary-fbs-filter-form/uqlibrary-fbs-filter-form.html">
<link rel="import" href="uqlibrary-rooms-list.html">
<link rel="import" href="../uqlibrary-fbs-booking-form/uqlibrary-fbs-booking-form.html">

<polymer-element name="uqlibrary-booking">

  <template>
    <link rel="stylesheet" href="uqlibrary-booking.css">

    <core-drawer-panel id="drawerPanel" responsiveWidth="9999px">

      <core-header-panel drawer id="drawer">
        <core-menu selectedAttribute="">
          <paper-item>Dashboard</paper-item>
          <paper-item>Agenda</paper-item>
          <paper-item>Study</paper-item>
          <paper-item>Library</paper-item>
          <paper-item>News</paper-item>
          <paper-item>Events</paper-item>
          <paper-item>Settings</paper-item>
          <paper-item>Logout</paper-item>
        </core-menu>
      </core-header-panel>

      <core-header-panel main id="main">
        <core-toolbar>
          <paper-icon-button id="toolBarLeftButton"
                             hidden?="{{!pageToolbar.leftButton.icon}}"
                             icon="{{pageToolbar.leftButton.icon ? pageToolbar.leftButton.icon : ''}}"
                             on-tap="{{doTransition}}"></paper-icon-button>
          <span flex id="toolbar-page-title">{{pageToolbar.title}}</span>
          <paper-icon-button on-click="{{launchIntoFullscreen}}"
                             icon="fullscreen"
                             hidden?="{{currentPage!=='myBookings'}}"></paper-icon-button>
          <paper-icon-button id="toolBarRightButton"
                             on-tap="{{doTransition}}"
                             hidden?="{{!pageToolbar.rightButton.icon}}"
                             icon="{{pageToolbar.rightButton.icon ? pageToolbar.rightButton.icon : ''}}"></paper-icon-button>
        </core-toolbar>

        <div id="content">
          <core-animated-pages id="pages"
                               transitions="{{transition}}"
                                on-core-animated-pages-transition-prepare="{{transitionPrepareHandler}}"
                                on-core-animated-pages-transition-end="{{transitionEndHandler}}"
            >
            <section id="myBookings">
              <uqlibrary-timeline  events="{{events}}"></uqlibrary-timeline>
              <paper-fab hero-id="filterForm"
                         hero?="{{transition === 'hero-transition'}}"
                         id="addBookingButton"
                         icon="add"
                         class="action"
                         hidden?="{{transitioning}}"
                         on-tap="{{doTransition}}"></paper-fab>
            </section>

            <section id="filterForm">
              <div horizontal center-justified layout>
              <uqlibrary-fbs-filter-form id="fbsFilterForm"
                                         hero-id="filterForm"
                                         on-filter-form-submitted="{{filterFormSubmitted}}"
                                         hero?="{{transition === 'hero-transition'}}"
                                         formData="{{filterFormData}}" selectedValues={{filterFormSelectedValues}}></uqlibrary-fbs-filter-form>
              </div>
            </section>


            <section id="results">
            </section>

            <section id="bookingFormSection">
              <uqlibrary-fbs-booking-form id="bookingForm" on-booking-created="{{updateMyBookings}}"></uqlibrary-fbs-booking-form>
            </section>


          </core-animated-pages>

        </div>

      </core-header-panel>

    </core-drawer-panel>

  </template>

  <script>
    (function() {
      Polymer('uqlibrary-booking', {

        transition: 'hero-transition',
        currentPage: 'myBookings',
        transitioning: false,

        ready: function() {
          this.pageTransitions = {
            addBookingButton: {
              transition: 'hero-transition',
              destination: 'filterForm',
              action: 'showFilterForm'
            }
          };
          this.showMyBookings();
        },

        created: function () {
          this.loadEvents();
          this.loadFilterFormData();
        },

        togglePanel: function () {
          this.$.drawerPanel.togglePanel();
        },

        launchIntoFullscreen: function () {
          var element = document.querySelector('uqlibrary-booking');
          if (element.requestFullscreen) {
            element.requestFullscreen();
          } else if (element.mozRequestFullScreen) {
            element.mozRequestFullScreen();
          } else if (element.webkitRequestFullscreen) {
            element.webkitRequestFullscreen();
          } else if (element.msRequestFullscreen) {
            element.msRequestFullscreen();
          }
        },

        doTransition: function (e, data, sender) {
          var p = this.pageTransitions[sender.id];
          if (p.transition) {
            this.transition = p.transition;
          }
          if (p.destination) {
            this.$.pages.selectedItem = this.$[p.destination];
            this.currentPage = p.destination;
          }
          if (p.action) {
            this[p.action]();
          }
        },

        transitionPrepareHandler: function() {
          this.transitioning = true;
        },

        transitionEndHandler: function(e) {
          this.transitioning = false;
          if(e.target.selectedItem.id == 'results') {
            this.createResultsList();
          }
        },

        showMyBookings: function() {
          this.pageTransitions.toolBarLeftButton = {
            action: 'togglePanel'
          };

          this.pageToolbar = {
            leftButton: {icon:'menu'},
            title: 'My bookings'
          };

        },

        showFilterForm: function() {
          this.pageTransitions.toolBarLeftButton = {
            transition: 'slide-from-right',
            destination: 'myBookings',
            action: 'showMyBookings'
          };

          this.pageTransitions.toolBarRightButton = {
            transition: 'slide-from-right',
            action: 'submitFilterForm'
          };

          this.pageTransitions.fbsFilterForm = {
              transition: 'slide-from-right',
              destination: 'results',
              action: 'showResultsPage'
          };

          this.pageToolbar = {
            leftButton: {icon:'arrow-back'},
            rightButton: {icon:'check'},
            title: 'Find a room'
          };
        },

        submitFilterForm: function() {
          this.$.fbsFilterForm.fire('submit-form');
        },

        filterFormSubmitted: function(e, data, sender) {
          var formData = e.detail.formData;

          if(!formData.equipment.pc) { // Just for testing
            this.$.fbsFilterForm.showInfoToast('No rooms found for selected filter');
          } else {
            this.doTransition(e, data, sender);
          }
        },

        showResultsPage: function() {
          this.pageTransitions.toolBarLeftButton = {
            transition: 'slide-from-right',
            destination: 'filterForm',
            action: 'showFilterForm'
          };

          this.pageToolbar = {
            leftButton: {icon:'arrow-back'},
            title: 'Select a room'
          };

          this.pageTransitions.resultsList = {
            transition: 'slide-from-right',
            destination: 'bookingFormSection',
            action: 'showBookingForm'
          }

          // Load results
          this.generateListData();
          this.addEventListener('room-selected', this.roomSelected);

        },

        createResultsList: function() {

          // Remove existing rooms list
          var currentList = this.$.results.querySelector('uqlibrary-rooms-list');
          if (currentList) {
            currentList.parentNode.removeChild(currentList);
          }


          var roomsList = document.createElement('uqlibrary-rooms-list');
          roomsList.setAttribute('id', 'resultsList');
          roomsList.setData(this.listData);

          var container = document.querySelector("#main /deep/ #mainContainer");
          if(container && container.offsetHeight) {
            roomsList.setAttribute('style', "height: " + container.offsetHeight +'px;');
          }
          this.$.results.appendChild(roomsList);

          // Set core-list height after loading items
          var list = document.querySelector('uqlibrary-rooms-list /deep/ core-list');
          if(container && container.offsetHeight) {
            list.setAttribute('style', list.getAttribute('style') + "; height: " + container.offsetHeight +'px;');
          }
        },

        roomSelected: function(event, data, sender) {

          //set selected room details in booking form
          this.$.bookingForm.roomDetails = event.detail.item;

          this.doTransition(event, data, { id: 'resultsList' });
        },

        showBookingForm: function() {

          this.pageTransitions.bookingForm = {
            transition: 'slide-from-left',
            destination: 'myBookings',
            action: 'showMyBookings'
          }

          this.pageTransitions.toolBarLeftButton = {
            transition: 'slide-from-right',
            destination: 'results',
            action: 'showResultsPage'
          };

          this.pageTransitions.toolBarRightButton = {
            transition: 'slide-from-left',
            action: 'submitBookingForm'
          };

          this.pageToolbar = {
            leftButton: { icon:'arrow-back' },
            rightButton: { icon:'check' },
            title: 'Book a room'
          };

          //set search filter data - date, duration
          var searchDate = this.$.fbsFilterForm.selectedValues.searchDate ?
                  this.$.fbsFilterForm.selectedValues.searchDate : new Date();
          this.$.bookingForm.searchDate = searchDate;
          this.$.bookingForm.searchDuration = 60 * this.$.fbsFilterForm.selectedDuration; //in minutes
          //TODO: maybe this should be a global setting?
          this.$.bookingForm.maxBookingDate = new Date((new Date().getTime()) + 7 * 24 * 60 * 60 * 1000);

        },

        submitBookingForm: function() {
          this.$.bookingForm.fire('submit-form');
        },

        updateMyBookings: function(e, data, sender) {

          // add new booking details to events on timeline
          this.events.push({
            date: data.bookingStart,
            title: data.bookingTitle,
            subtitle: data.bookingLocation,
            text: data.bookingStart.toTimeString() + " - " + data.bookingEnd.toTimeString()
          });

          // transition to timeline
          this.doTransition(e, data, {id: 'bookingForm'});
        },

        // MOCK DATA
        loadEvents: function () {
          this.events = [
            {
              date: new Date().setHours(0, 0, 0, 0),
              title: "Item title",
              subtitle: "Second line",
              text: "Third line"
            },
            {
              date: new Date().setHours(25, 0, 0, 0),
              title: "Item title",
              subtitle: "Second line",
              text: "Third line"
            },
            {
              date: new Date().setHours(26, 0, 0, 0),
              title: "Item title",
              subtitle: "Second line",
              text: "Third line"
            },
            {
              date: new Date().setHours(72, 0, 0, 0),
              title: "Item title",
              subtitle: "Second line",
              text: "Third line"
            }
          ];
        },
        loadFilterFormData: function() {
          this.filterFormData = {};
          this.filterFormData.dates = [];
          var today = new Date();
          for(var i = 0; i < 7; i++) {
            this.filterFormData.dates.push({
              date: new Date().setDate(today.getDate() + i)
            });
          }


          this.filterFormData.facilities = [
            {
              title: 'St Lucia',
              id: 'stlucia',
              buildings: [
                {
                  title: 'Biological Sciences Library',
                  id: 'bsl',
                  rooms: [
                    {
                      title: 'Biological Sciences Library Group Room 1',
                      id: 'gr1'

                    },
                    {
                      title: 'Group Room 2',
                      id: 'gr2'

                    },
                    {
                      title: 'Individual Room',
                      id: 'ir'

                    }

                  ]

                },
                {
                  title: 'Duhig Building',
                  id: 'dh',
                  rooms: [
                    {
                      title: 'Group Room 1',
                      id: 'gr1'

                    },
                    {
                      title: 'Projector',
                      id: 'projector'

                    },
                    {
                      title: 'Individual Room',
                      id: 'ir'

                    }

                  ]

                },
                {
                  title: 'Duhig Building 1',
                  id: 'dh1',
                  rooms: [
                    {
                      title: 'Group Room 1',
                      id: 'gr1'

                    },
                    {
                      title: 'Projector',
                      id: 'projector'

                    },
                    {
                      title: 'Individual Room',
                      id: 'ir'

                    }

                  ]

                },
                {
                  title: 'Duhig Building',
                  rooms: [
                    {
                      title: 'Group Room 1',
                      id: 'gr1'

                    },
                    {
                      title: 'Projector',
                      id: 'projector'

                    },
                    {
                      title: 'Individual Room',
                      id: 'ir'

                    }

                  ]

                },
                {
                  title: 'Duhig Building 2',
                  id: 'dh2',
                  rooms: [
                    {
                      title: 'Group Room 1',
                      id: 'gr1'
                    },
                    {
                      title: 'Projector',
                      id: 'projector'

                    },
                    {
                      title: 'Individual Room',
                      id: 'ir'

                    }

                  ]

                },
              ]
            },
            {
              title: 'Gatton',
              id: 'gatton',
              buildings: [
                {
                  title: 'Gatton Biological Sciences Library',
                  id: 'bsl',
                  rooms: [
                    {
                      title: 'Group Room 1',
                      id: 'gr1'

                    },
                    {
                      title: 'Group Room 2',
                      id: 'gr2'

                    },
                    {
                      title: 'Individual Room',
                      id: 'ir'

                    }

                  ]

                },
                {
                  title: 'Gatton Duhig Building',
                  id: 'dh',
                  rooms: [
                    {
                      title: 'Group Room 1',
                      id: 'gr1'

                    },
                    {
                      title: 'Projector',
                      id: 'projector'

                    },
                    {
                      title: 'Individual Room',
                      id: 'ir'

                    }

                  ]

                },
                {
                  title: 'Gatton Duhig Building 1',
                  id: 'dh1',
                  rooms: [
                    {
                      title: 'Group Room 1',
                      id: 'gr1'

                    },
                    {
                      title: 'Projector',
                      id: 'projector'

                    },
                    {
                      title: 'Individual Room',
                      id: 'ir'

                    }

                  ]

                },

              ]
            },

          ];
            this.filterFormSelectedValues = {campus: 'gatton', building: 'gatton:bsl', room: 'gatton:bsl:gr2', date: '', time: '', capacity: 10, duration: 1.5, equipment: {pc: true} };

        },
        generateListData: function() {
          this.listData = [];
          var names = ["Data Projector", "Group Study Rooms - level 6", "Conference & Other - Level 3", "Group Rooms", "Group Study Rooms", "Group Study Rooms", "Data Projector", "Group  Rooms - Level 3", "Data Projectors", "Assistive Technology Rooms - Level 4", "Group Study Rooms", "Group Rooms, Levels 2, 3 & 4", "Data Projector"], data = [];
          var strings = [
            "8 - 9a",
            "8.30 - 9.30a",
            "9 - 10a"
          ];

          for (var i=0; i < names.length; i++) {
            this.listData.push({
              id: i,
              name:  names[i],
              room: names[i],
              level: "Level 3",
              building: "Biological Sciences Library",
              campus: "St Lucia",
              summary: "6 chairs, 1 table, PC, Large Screen, whiteboard. The PC is temporarily out of order.",
              image: 'test/images/images-resized/'+ (i % 4) + '.jpg',
              imageLarge: 'test/images/images-resized/'+ (i % 4) + '.jpg',

              timeslotLength: 30,     //in minutes
              maxBookingLength: 120,  //in minutes
              minBookingLength: 30,    //in minutes

              checked: false,
              details: strings[i % 3]
            });
          }
        }
      });
    })();
  </script>

</polymer-element>
