<link rel="import" href="../uqlibrary-elements/0.5.1/lib/vulcanized.html">
<link rel="import" href="uqlibrary-rooms-list.html">
<link rel="import" href="uqlibrary-fbs-filter-form.html">
<link rel="import" href="uqlibrary-fbs-booking-form.html">
<link rel="import" href="uqlibrary-fbs-booking-display.html">

<polymer-element name="uqlibrary-booking">

  <template>
    <link rel="stylesheet" href="uqlibrary-booking.css">

    <uqlibrary-ga id="ga" appName="FBS"></uqlibrary-ga>

    <uqlibrary-api-account id="account"></uqlibrary-api-account>
    <uqlibrary-api-account-bookings id="bookings"></uqlibrary-api-account-bookings>
    <uqlibrary-api-facilities-availability id="facilities"></uqlibrary-api-facilities-availability>

    <core-drawer-panel id="drawerPanel" responsiveWidth="9999px">

      <core-header-panel drawer id="drawer">
        <core-menu selectedAttribute="">
          <paper-item>Dashboard</paper-item>
          <paper-item>Agenda</paper-item>
          <paper-item>Study</paper-item>
          <paper-item>Library</paper-item>
          <paper-item>News</paper-item>
          <paper-item>Events</paper-item>
          <paper-item>Settings</paper-item>
          <paper-item>Logout</paper-item>
        </core-menu>
      </core-header-panel>

      <core-header-panel main id="main">
        <core-toolbar>
          <paper-icon-button id="toolBarLeftButton"
                             hidden?="{{!pageToolbar.leftButton.icon}}"
                             icon="{{pageToolbar.leftButton.icon ? pageToolbar.leftButton.icon : ''}}"
                             on-tap="{{doTransition}}"></paper-icon-button>
          <span flex id="toolbar-page-title">{{pageToolbar.title}}</span>
          <paper-icon-button id="toolBarRightButton"
                             on-tap="{{doTransition}}"
                             hidden?="{{!pageToolbar.rightButton.icon}}"
                             icon="{{pageToolbar.rightButton.icon ? pageToolbar.rightButton.icon : ''}}"></paper-icon-button>
        </core-toolbar>

        <div id="content">

          <core-animated-pages id="pages"
                               transitions="{{transition}}"
                                on-core-animated-pages-transition-prepare="{{transitionPrepareHandler}}"
                                on-core-animated-pages-transition-end="{{transitionEndHandler}}"
            >
            <section id="myBookings">
              <template if="{{events.length}}">
                <uqlibrary-timeline events="{{events}}" on-event-selected="{{eventSelected}}"></uqlibrary-timeline>
              </template>
              <paper-toast id="myBookingsInfoToast" flex></paper-toast>
              <paper-fab hero-id="filterForm"
                         hero?="{{transition === 'hero-transition'}}"
                         id="addBookingButton"
                         icon="add"
                         class="action"
                         hidden?="{{transitioning}}"
                         on-tap="{{doTransition}}"></paper-fab>
            </section>

            <section id="filterForm">

              <div horizontal center-justified layout >
                <uqlibrary-fbs-filter-form id="fbsFilterForm"
                                           hero-id="filterForm"
                                           on-filter-form-submitted="{{filterFormSubmitted}}"
                                           hero?="{{transition === 'hero-transition'}}"
                                           formData="{{filterFormData}}" selectedValues={{filterFormSelectedValues}}></uqlibrary-fbs-filter-form>
                </div>
            </section>

            <section id="results">
            </section>

            <section id="bookingFormSection">
              <uqlibrary-fbs-booking-form id="bookingForm" on-booking-created="{{bookingCreated}}"></uqlibrary-fbs-booking-form>
            </section>

            <section id="bookingDetailsSection">
              <uqlibrary-fbs-booking-display id="bookingDetails" on-booking-deleted="{{bookingDeleted}}"></uqlibrary-fbs-booking-display>
            </section>

          </core-animated-pages>

        </div>

      </core-header-panel>

    </core-drawer-panel>

  </template>

  <script>
    (function() {
      Polymer('uqlibrary-booking', {

        transition: 'hero-transition',
        currentPage: 'myBookings',
        transitioning: false,

        created: function () {
          this.facilities = [];
          this.rooms = [];
          this.user = {};
          this.loadFilterFormData();
        },

        ready: function() {
          var that = this;

          this.pageTransitions = {
            addBookingButton: {
              transition: 'hero-transition',
              destination: 'filterForm',
              action: 'showFilterForm'
            }
          };

          this.$.ga.addPageView(this.currentPage);

          this.$.account.addEventListener('uqlibrary-api-account-loaded', function(e) {
            if (e.detail.hasSession) {
              that.user = e.detail;
            } else {
              // Not logged in
              // TODO: Redirect to login
            }
          });
          this.$.account.get();

          this.$.facilities.addEventListener('uqlibrary-api-facilities-availability-loaded', function(e) {
            that.facilities = e.detail;
            if (that.facilities.length > 0) {
              that.buildFilterFormDataFacilitiesArray();
              that.showMyBookings();
            }
          });
          this.$.facilities.get();
        },

        togglePanel: function () {
          this.$.drawerPanel.togglePanel();
          this.$.ga.addEvent('launchIntoFullscreen');
        },

        showInfoToast: function(toast, text) {
          toast.text = text;
          toast.show();
        },

        doTransition: function (e, data, sender) {
          var p = this.pageTransitions[sender.id];
          if (p.transition) {
            this.transition = p.transition;
          }
          if (p.destination) {
            this.$.pages.selectedItem = this.$[p.destination];
            this.currentPage = p.destination;
          }

          if (p.action) {
            if (p.destination) {
              this.$.ga.addPageView(p.destination);
            } else {
              this.$.ga.addEvent(p.action);
            }
            this[p.action](data);
          }

        },

        transitionPrepareHandler: function(e) {
          this.transitioning = true;
          this.fire('core-signal', {name: "transition-prepare"});
        },

        transitionEndHandler: function(e) {
          this.transitioning = false;
          if(e.target.selectedItem.id == 'results') {
            this.createResultsList();
          }
          this.fire('core-signal', {name: "transition-end"});
        },

        showMyBookings: function() {
          var that = this;

          this.pageTransitions.toolBarLeftButton = {
            action: 'togglePanel'
          };

          this.pageToolbar = {
            leftButton: {icon:'menu'},
            title: 'My bookings'
          };

          this.pageTransitions.bookingDetails = {
            transition: 'slide-from-right',
            destination: 'bookingDetailsSection',
            action: 'showBookingDetails'
          };

          this.$.bookings.addEventListener('uqlibrary-api-account-bookings-loaded', function(e) {
            var bookings = e.detail;
            if (bookings.length > 0) {
              var events = [];
              bookings.forEach(function (b) {
                events.push({
                  id: b.id,
                  startDate: new Date(b.from * 1000),
                  endDate: new Date(b.to * 1000),
                  title: b.resource.title
                });
              });
              that.events = events;
            }
          });
          this.$.bookings.get();

        },

        showFilterForm: function() {
          this.pageTransitions.toolBarLeftButton = {
            transition: 'slide-from-right',
            destination: 'myBookings',
            action: 'showMyBookings'
          };

          this.pageTransitions.toolBarRightButton = {
            transition: 'slide-from-right',
            action: 'submitFilterForm'
          };

          this.pageTransitions.fbsFilterForm = {
              transition: 'slide-from-right',
              destination: 'results',
              action: 'showResultsPage'
          };

          this.pageToolbar = {
            leftButton: {icon:'arrow-back'},
            rightButton: {icon:'check'},
            title: 'Find a room'
          };
        },

        submitFilterForm: function() {
          this.$.fbsFilterForm.fire('submit-form');
        },

        filterFormSubmitted: function(e, data, sender) {
          var formData = e.detail.formData;
          this.doTransition(e, data, sender);

          // this.$.fbsFilterForm.showInfoToast('No rooms found for selected filter');

        },

        showResultsPage: function() {
          this.pageTransitions.toolBarLeftButton = {
            transition: 'slide-from-right',
            destination: 'filterForm',
            action: 'showFilterForm'
          };

          this.pageToolbar = {
            leftButton: {icon:'arrow-back'},
            title: 'Select a room'
          };

          this.pageTransitions.resultsList = {
            transition: 'slide-from-right',
            destination: 'bookingFormSection',
            action: 'showBookingForm'
          }

          // Load results
          this.generateListData();
          this.addEventListener('room-selected', this.roomSelected);

        },

        createResultsList: function() {

          // Remove existing rooms list
          var currentList = this.$.results.querySelector('uqlibrary-rooms-list');
          if (currentList) {
            currentList.parentNode.removeChild(currentList);
          }

          var roomsList = document.createElement('uqlibrary-rooms-list');
          roomsList.setAttribute('id', 'resultsList');
          roomsList.setData(this.listData);

          var container = document.querySelector("#main /deep/ #mainContainer");
          if(container && container.offsetHeight) {
            roomsList.setAttribute('style', "height: " + container.offsetHeight +'px;');
          }
          this.$.results.appendChild(roomsList);

          // Set core-list height after loading items
          var list = document.querySelector('uqlibrary-rooms-list /deep/ core-list');
          if(container && container.offsetHeight) {
            list.setAttribute('style', list.getAttribute('style') + "; height: " + container.offsetHeight +'px;');
          }
        },

        roomSelected: function(event, data, sender) {
          this.doTransition(event, event.detail.item, { id: 'resultsList' });
        },

        showBookingDetails : function (data) {

          this.$.bookingDetails.bookingDetails = data;

          //TODO: load room details for this booking
          this.$.bookingDetails.roomDetails = {
            id:       1,
            room:     data.title,
            campus:   data.subtitle,
            summary:  "6 chairs, 1 table, PC, Large Screen, whiteboard.",
            image:    "test/images/images-resized/0.jpg",
            imageLarge:    "test/images/images-resized/0.jpg"
          };

          this.pageToolbar = {
            leftButton: { icon:'arrow-back' },
            title: 'Booking details'
          };

          this.pageTransitions.toolBarLeftButton = {
            transition: 'slide-from-right',
            destination: 'myBookings',
            action: 'showMyBookings'
          };
        },

        showBookingForm: function(data) {
          //setup booking form page
          this.pageTransitions.bookingForm = {
            transition: 'slide-from-right',
            destination: 'myBookings',
            action: 'showMyBookings'
          }

          this.pageTransitions.toolBarLeftButton = {
            transition: 'slide-from-right',
            destination: 'results',
            action: 'showResultsPage'
          };

          this.pageTransitions.toolBarRightButton = {
            transition: 'slide-from-right',
            action: 'submitBookingForm'
          };

          this.pageToolbar = {
            leftButton: { icon:'arrow-back' },
            rightButton: { icon:'check' },
            title: 'Book a room'
          };

          //setup booking form properties
          this.$.bookingForm.roomDetails = data;
          var searchDate = this.$.fbsFilterForm.selectedValues.searchDate ?
                  this.$.fbsFilterForm.selectedValues.searchDate : new Date();
          this.$.bookingForm.searchDate = searchDate;
          this.$.bookingForm.searchDuration = 60 * this.$.fbsFilterForm.selectedDuration; //in minutes
          //TODO: maybe this should be a global setting?
          this.$.bookingForm.maxBookingDate = new Date((new Date().getTime()) + 7 * 24 * 60 * 60 * 1000);

        },

        submitBookingForm: function() {
          this.$.bookingForm.fire('submit-form');
        },

        eventSelected: function(e, data, sender){
          //transition to booking details
          this.doTransition(e, data, {id: 'bookingDetails'});
        },

        bookingDeleted: function(e, data, sender){
          this.$.ga.addEvent('bookingDeleted');

          //Remove event from this.events
          var deletedEvent = e.detail;
          var eventIndex = -1;
          for(var i=0; i<this.events.length; i++) {
            if(this.events[i].id == deletedEvent.id){
              eventIndex = i;
            }
          }
          this.events.splice(eventIndex, 1);

          //Transition to timeline page
          this.doTransition(e, data, {id: 'toolBarLeftButton'});

          //Show toast that event was deleted
          this.showInfoToast(this.$.myBookingsInfoToast, "Your booking was deleted.");
        },

        bookingCreated: function(e, data, sender) {
          this.$.ga.addEvent('bookingCreated');

          // add new booking details to events on timeline
          this.events.push(data);

          // transition to timeline
          this.doTransition(e, data, {id: 'bookingForm'});
        },

        buildFilterFormDataFacilitiesArray: function() {
          this.filterFormData.facilities = [];
          var _facilities = {};

          for(var i = 0; i < this.facilities.length; i++) {
            for(var j =0; j < this.facilities[i].resources.length; j++){
              for(var k =0; k < this.facilities[i].resources[j].facilities.length; k++){
                var _facility = this.facilities[i].resources[j].facilities[k];

                if (!_facilities[_facility.campus]) {

                  _facilities[_facility.campus] = {
                    id: _facility.campus,
                    title: _facility.campus,
                    buildingsObjects: {}
                  };
                }

                if(!_facilities[_facility.campus].buildingsObjects[_facility.building]) {
                  _facilities[_facility.campus].buildingsObjects[_facility.building] = {

                    id: _facility.building,
                    title: _facility.building,
                    rooms: []

                  };
                }
                _facilities[_facility.campus].buildingsObjects[_facility.building].rooms.push(
                  {
                    id: _facility.id,
                    title: _facility.title,
                    capacity: _facility.capacity,
                    maxtime: _facility.maxtime,
                    mintime: _facility.mintime
                  });

                this.rooms[_facility.id] = {
                    id: _facility.id,
                    title: _facility.title,
                    capacity: _facility.capacity,
                    maxtime: _facility.maxtime,
                    mintime: _facility.mintime,
                    bookings: _facility.bookings,
                    url: _facility.url
                  };
              }
            }
          }

          var _campusKeys = Object.keys(_facilities);
          for(var i = 0; i < _campusKeys.length; i++) {

            var _buildingsKeys = Object.keys(_facilities[_campusKeys[i]].buildingsObjects);
            _facilities[_campusKeys[i]].buildings = [];
            for(var j = 0; j < _buildingsKeys.length; j++) {
              _facilities[_campusKeys[i]].buildings.push(_facilities[_campusKeys[i]].buildingsObjects[_buildingsKeys[j]]);
            }
            delete(_facilities[_campusKeys[i]].buildingsObjects);
            this.filterFormData.facilities.push(_facilities[_campusKeys[i]]);
          }

          // Sort array based on number of available buildings
          this.filterFormData.facilities.sort(function(a, b){return b.buildings.length - a.buildings.length });

        },



        // MOCK DATA
        loadFilterFormData: function() {
          this.filterFormData = {};
          this.filterFormData.dates = [];
          var today = new Date();
          for(var i = 0; i < 7; i++) {
            this.filterFormData.dates.push({
              date: new Date().setDate(today.getDate() + i)
            });
          }
        },

        generateListData: function() {
          this.listData = [];
          var names = ["Data Projector", "Group Study Rooms - level 6", "Conference & Other - Level 3", "Group Rooms", "Group Study Rooms", "Group Study Rooms", "Data Projector", "Group  Rooms - Level 3", "Data Projectors", "Assistive Technology Rooms - Level 4", "Group Study Rooms", "Group Rooms, Levels 2, 3 & 4", "Data Projector"], data = [];
          var strings = [
            "8 - 9a",
            "8.30 - 9.30a",
            "9 - 10a"
          ];

          for (var i=0; i < names.length; i++) {
            this.listData.push({
              id: i,
              name:  names[i],
              room: names[i],
              level: "Level 3",
              building: "Biological Sciences Library",
              campus: "St Lucia",
              summary: "6 chairs, 1 table, PC, Large Screen, whiteboard. The PC is temporarily out of order.",
              image: 'test/images/images-resized/'+ (i % 4) + '.jpg',
              imageLarge: 'test/images/images-resized/'+ (i % 4) + '.jpg',

              timeslotLength: 30,     //in minutes
              maxBookingLength: 120,  //in minutes
              minBookingLength: 30,    //in minutes

              checked: false,
              details: strings[i % 3]
            });
          }
        }
      });
    })();
  </script>

</polymer-element>
