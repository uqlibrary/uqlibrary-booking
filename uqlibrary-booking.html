<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../core-animated-pages/core-animated-pages.html">
<link rel="import" href="../core-animated-pages/transitions/slide-from-right.html">
<link rel="import" href="../core-animated-pages/transitions/hero-transition.html">
<link rel="import" href="../core-animated-pages/transitions/cross-fade.html">

<link rel="import" href="../core-drawer-panel/core-drawer-panel.html">
<link rel="import" href="../core-header-panel/core-header-panel.html">
<link rel="import" href="../core-toolbar/core-toolbar.html">
<link rel="import" href="../core-menu/core-menu.html">
<link rel="import" href="../core-icons/core-icons.html">
<link rel="import" href="../core-icons/social-icons.html">
<link rel="import" href="../core-icons/av-icons.html">

<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-fab/paper-fab.html">

<link rel="import" href="../uqlibrary-timeline/uqlibrary-timeline.html">
<link rel="import" href="../uqlibrary-fbs-filter-form/uqlibrary-fbs-filter-form.html">
<link rel="import" href="uqlibrary-rooms-list.html">
<link rel="import" href="../uqlibrary-fbs-booking-form/uqlibrary-fbs-booking-form.html">

<polymer-element name="uqlibrary-booking">

  <template>
    <link rel="stylesheet" href="uqlibrary-booking.css">

    <core-drawer-panel id="drawerPanel" responsiveWidth="9999px">

      <core-header-panel drawer id="drawer">
        <core-menu>
          <paper-item label="Dashboard"></paper-item>
          <paper-item label="Agenda"></paper-item>
          <paper-item label="Study"></paper-item>
          <paper-item label="Library"></paper-item>
          <paper-item label="News"></paper-item>
          <paper-item label="Events"></paper-item>
          <paper-item label="Settings"></paper-item>
          <paper-item label="Logout"></paper-item>
        </core-menu>
      </core-header-panel>

      <core-header-panel main id="main">
        <core-toolbar>
          <paper-icon-button id="toolBarLeftButton"
                             hidden?="{{!pageToolbar.leftButton.icon}}"
                             icon="{{pageToolbar.leftButton.icon ? pageToolbar.leftButton.icon : ''}}"
                             on-tap="{{doTransition}}"></paper-icon-button>
          <span flex id="toolbar-page-title">{{pageToolbar.title}}</span>
          <paper-icon-button id="toolBarRightButton"
                             on-tap="{{doTransition}}"
                             hidden?="{{!pageToolbar.rightButton.icon}}"
                             icon="{{pageToolbar.rightButton.icon ? pageToolbar.rightButton.icon : ''}}"></paper-icon-button>
        </core-toolbar>

        <div id="content">
          <core-animated-pages id="pages"
                               transitions="{{transition}}"
                                on-core-animated-pages-transition-end="{{transitionEndHandler}}"
            >
            <section id="myBookings">
                <div class="wrapper">
                  <uqlibrary-timeline  events="{{events}}"></uqlibrary-timeline>
                  <paper-fab hero-id="filterForm"
                             hero?="{{transition === 'hero-transition'}}"
                  id="addBookingButton"
                  icon="add"
                  class="action"
                  on-tap="{{doTransition}}"></paper-fab>
                </div>
            </section>

            <section id="filterForm">
              <div horizontal center-justified layout>
              <uqlibrary-fbs-filter-form id="fbsFilterForm"
                                         hero-id="filterForm"
                                         on-filter-form-submitted="{{filterFormSubmitted}}"
                                         hero?="{{transition === 'hero-transition'}}"
                                         formData="{{filterFormData}}" selectedValues={{filterFormData.selectedValues}}></uqlibrary-fbs-filter-form>
              </div>
            </section>


            <section id="results">
            </section>

            <section id="roomBookingForm">
              <uqlibrary-fbs-booking-form id="bookingForm"></uqlibrary-fbs-booking-form>
            </section>


          </core-animated-pages>

        </div>

      </core-header-panel>

    </core-drawer-panel>

  </template>

  <script>
    (function() {
      Polymer('uqlibrary-booking', {

        transition: 'hero-transition',

        ready: function() {
          this.pageTransitions = {
            addBookingButton: {
              transition: 'hero-transition',
              destination: 'filterForm',
              action: 'showFilterForm'
            }
          };
          this.showMyBookings();
        },

        created: function () {
          this.loadEvents();
          this.loadFilterFormData();
        },

        togglePanel: function () {
          this.$.drawerPanel.togglePanel();
        },

        doTransition: function (e, data, sender) {
          var p = this.pageTransitions[sender.id];
          if (p.transition) {
            this.transition = p.transition;
          }
          if (p.destination) {
            this.$.pages.selectedItem = this.$[p.destination];
          }
          if (p.action) {
            this[p.action]();
          }
        },

        transitionEndHandler: function(e) {
          if(e.target.selectedItem.id == 'results') {
            this.createResultsList();
          }
        },

        showMyBookings: function() {
          this.pageTransitions.toolBarLeftButton = {
            action: 'togglePanel'
          };

          this.pageToolbar = {
            leftButton: {icon:'menu'},
            title: 'My bookings'
          };

        },

        showFilterForm: function() {
          this.pageTransitions.toolBarLeftButton = {
            transition: 'slide-from-right',
            destination: 'myBookings',
            action: 'showMyBookings'
          };

          this.pageTransitions.toolBarRightButton = {
            transition: 'slide-from-right',
            action: 'submitFilterForm'
          };

          this.pageTransitions.fbsFilterForm = {
              transition: 'slide-from-right',
              destination: 'results',
              action: 'showResultsPage'
          };

          this.pageToolbar = {
            leftButton: {icon:'arrow-back'},
            rightButton: {icon:'check'},
            title: 'Find a room'
          };
        },

        submitFilterForm: function() {
          this.$.fbsFilterForm.fire('filter-form-submitted', {formData: this.$.fbsFilterForm.selectedValues});
        },

        filterFormSubmitted: function(e, data, sender) {
          var formData = e.detail.formData;
          if(!formData.equipment.pc) { // Just for testing
            this.$.fbsFilterForm.showInfoToast('No rooms found for selected filter');
          } else {
            this.doTransition(e, data, sender);
          }
        },

        showResultsPage: function() {
          this.generateListData();
          this.pageTransitions.toolBarLeftButton ={
            transition: 'slide-from-right',
            destination: 'filterForm',
            action: 'showFilterForm'
          };

          this.pageToolbar = {
            leftButton: {icon:'arrow-back'},
            title: 'Select a room'
          };

          this.pageTransitions.resultsList = {
            transition: 'slide-from-right',
            destination: 'roomBookingForm',
            action: 'showRoomBookingPage'
          }


          // Load results
          this.generateListData();
          this.addEventListener('room-selected', this.roomSelected);

        },

        createResultsList: function() {

          var roomsList = document.createElement('uqlibrary-rooms-list');
          roomsList.setAttribute('id', 'resultsList');
          roomsList.setData(this.listData);

          var container = this.$.main.querySelector('::shadow #mainContainer');
          if(container && container.offsetHeight) {
            roomsList.setAttribute('style', "height: " + container.offsetHeight +'px;');
          }

          this.$.results.appendChild(roomsList);
          // Set core-list height after loading items
          var list = document.querySelector('uqlibrary-rooms-list::shadow core-list');
          var container = this.$.main.querySelector('::shadow #mainContainer');
          if(container && container.offsetHeight) {
            list.setAttribute('style', list.getAttribute('style') + "; height: " + container.offsetHeight +'px;');
          }
        },

        roomSelected: function(e, data, sender) {
          this.doTransition(e, data, {id: 'resultsList'});
        },

        showRoomBookingPage: function() {
          this.pageTransitions.toolBarLeftButton = {
            transition: 'slide-from-right',
            destination: 'results',
            action: 'showResultsPage'
          };
          this.pageTransitions.toolBarRightButton = {
            transition: 'slide-from-right',
            destination: 'myBookings',
            action: 'saveBooking'
          };


          this.pageToolbar = {
            leftButton: {icon:'arrow-back'},
            title: 'Book a room',
            rightButton: {icon:'check'}
          };

          this.loadRoomDetailsData();
        },


        saveBooking: function(e, data, sender) {

          // save booking
          this.events.push({
            date: new Date().setHours(55, 0, 0, 0),
            title: "New added Booking",
            subtitle: "Second line",
            text: "Third line"});
          this.showMyBookings();

        },



        // MOCK DATA

        loadEvents: function () {
          this.events = [
            {
              date: new Date().setHours(0, 0, 0, 0),
              title: "Item title",
              subtitle: "Second line",
              text: "Third line"
            },
            {
              date: new Date().setHours(25, 0, 0, 0),
              title: "Item title",
              subtitle: "Second line",
              text: "Third line"
            },
            {
              date: new Date().setHours(26, 0, 0, 0),
              title: "Item title",
              subtitle: "Second line",
              text: "Third line"
            },
            {
              date: new Date().setHours(72, 0, 0, 0),
              title: "Item title",
              subtitle: "Second line",
              text: "Third line"
            }
          ];
        },
        loadFilterFormData: function() {
          this.filterFormData = [];
          this.filterFormData.dates = [];
          var today = new Date();
          for(var i = 0; i < 7; i++) {
            this.filterFormData.dates.push({
              date: new Date().setDate(today.getDate() + i)
            });
          }


          this.filterFormData.facilities = [
            {
              title: 'St Lucia',
              id: 'stlucia',
              buildings: [
                {
                  title: 'Biological Sciences Library',
                  id: 'bsl',
                  rooms: [
                    {
                      title: 'Biological Sciences Library Group Room 1',
                      id: 'gr1'

                    },
                    {
                      title: 'Group Room 2',
                      id: 'gr2'

                    },
                    {
                      title: 'Individual Room',
                      id: 'ir'

                    }

                  ]

                },
                {
                  title: 'Duhig Building',
                  id: 'dh',
                  rooms: [
                    {
                      title: 'Group Room 1',
                      id: 'gr1'

                    },
                    {
                      title: 'Projector',
                      id: 'projector'

                    },
                    {
                      title: 'Individual Room',
                      id: 'ir'

                    }

                  ]

                },
                {
                  title: 'Duhig Building 1',
                  id: 'dh1',
                  rooms: [
                    {
                      title: 'Group Room 1',
                      id: 'gr1'

                    },
                    {
                      title: 'Projector',
                      id: 'projector'

                    },
                    {
                      title: 'Individual Room',
                      id: 'ir'

                    }

                  ]

                },
                {
                  title: 'Duhig Building',
                  rooms: [
                    {
                      title: 'Group Room 1',
                      id: 'gr1'

                    },
                    {
                      title: 'Projector',
                      id: 'projector'

                    },
                    {
                      title: 'Individual Room',
                      id: 'ir'

                    }

                  ]

                },
                {
                  title: 'Duhig Building 2',
                  id: 'dh2',
                  rooms: [
                    {
                      title: 'Group Room 1',
                      id: 'gr1'
                    },
                    {
                      title: 'Projector',
                      id: 'projector'

                    },
                    {
                      title: 'Individual Room',
                      id: 'ir'

                    }

                  ]

                },
              ]
            },
            {
              title: 'Gatton',
              id: 'gatton',
              buildings: [
                {
                  title: 'Gatton Biological Sciences Library',
                  id: 'bsl',
                  rooms: [
                    {
                      title: 'Group Room 1',
                      id: 'gr1'

                    },
                    {
                      title: 'Group Room 2',
                      id: 'gr2'

                    },
                    {
                      title: 'Individual Room',
                      id: 'ir'

                    }

                  ]

                },
                {
                  title: 'Gatton Duhig Building',
                  id: 'dh',
                  rooms: [
                    {
                      title: 'Group Room 1',
                      id: 'gr1'

                    },
                    {
                      title: 'Projector',
                      id: 'projector'

                    },
                    {
                      title: 'Individual Room',
                      id: 'ir'

                    }

                  ]

                },
                {
                  title: 'Gatton Duhig Building 1',
                  id: 'dh1',
                  rooms: [
                    {
                      title: 'Group Room 1',
                      id: 'gr1'

                    },
                    {
                      title: 'Projector',
                      id: 'projector'

                    },
                    {
                      title: 'Individual Room',
                      id: 'ir'

                    }

                  ]

                },

              ]
            },

          ];

          this.filterFormData.selectedValues = {campus: 'gatton', building: 'gatton:bsl', room: 'gatton:bsl:gr2', date: '9/11/2014', time: '14:45', capacity: 10, duration: 1.5, equipment: {pc: true} };

        },
        generateListData: function() {
          this.listData = [];
          var names = ["Data Projector", "Group Study Rooms - level 6", "Conference & Other - Level 3", "Group Rooms", "Group Study Rooms", "Group Study Rooms", "Data Projector", "Group  Rooms - Level 3", "Data Projectors", "Assistive Technology Rooms - Level 4", "Group Study Rooms", "Group Rooms, Levels 2, 3 & 4", "Data Projector"], data = [];
          var strings = [
            "8 - 9a",
            "8.30 - 9.30a",
            "9 - 10a"
          ];
          for (var i=0; i < names.length; i++) {
            this.listData.push({
              id: i,
              room: names[i],
              building: 'Biological Sciences Library',
              campus: 'St Lucia',
              details: strings[i % 3],
              image: 'test/images/images-resized/'+ (i % 4) + '.jpg',
              checked: false,
              name: i
            });
          }
        },

        loadRoomDetailsData: function() {
          this.$.bookingForm.roomDetails = {
            name: "Group Room 3",
            level: "Level 3",
            building: "Biological Sciences Library",
            campus: "St Lucia",
            summary: "6 chairs, 1 table, PC, Large Screen, whiteboard. The PC is temporarily out of order.",
            image: "../uqlibrary-fbs-booking-form/images/image.jpg",
            timeslotLength: 30,     //in minutes
            maxBookingLength: 120,  //in minutes
            minBookingLength: 30    //in minutes
          };


          var today = new Date();

          this.$.bookingForm.searchDate = new Date(today.getTime() + 2 * 24 * 60 * 60 * 1000);
          this.$.bookingForm.maxBookingDate = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
          this.$.bookingForm.bookingTimeslots = [
            {
              startTime : '8:00 am',
              selectable: false,
              selected: false
            },
            {
              startTime : '8:30 am',
              selectable: true,
              selected: false
            },
            {
              startTime : '9:00 am',
              selectable: true,
              selected: false
            },
            {
              startTime : '9:30 am',
              selectable: true,
              selected: false
            },
            {
              startTime : '10:00 am',
              selectable: true,
              selected: false
            },
            {
              startTime : '10:30 am',
              selectable: true,
              selected: false
            },
            {
              startTime : '11:00 am',
              selectable: true,
              selected: false
            },
            {
              startTime : '11:30 am',
              selectable: true,
              selected: false
            },
            {
              startTime : '12:00 pm',
              selectable: true,
              selected: false
            },
            {
              startTime : '12:30 pm',
              selectable: true,
              selected: false
            },
            {
              startTime : '1:00 pm',
              selectable: true,
              selected: false
            },
            {
              startTime : '1:30 pm',
              selectable: true,
              selected: false
            },
            {
              startTime : '2:00 pm',
              selectable: false,
              selected: false
            },
            {
              startTime : '2:30 pm',
              selectable: false,
              selected: false
            },
            {
              startTime : '3:00 pm',
              selectable: false,
              selected: false
            },

            {
              startTime : '3:30 pm',
              selectable: true,
              selected: false
            },
            {
              startTime : '4:00 pm',
              selectable: true,
              selected: true
            },
            {
              startTime : '4:30 pm',
              selectable: true,
              selected: true
            },
            {
              startTime : '5:00 pm',
              selectable: true,
              selected: true
            },
            {
              startTime : '5:30 pm',
              selectable: true,
              selected: true
            }
          ];

        }


      });
    })();
  </script>

</polymer-element>
