<link rel="import" href="../uqlibrary-elements/0.5.1/lib/vulcanized.html">

<!--
Element providing a form for booking a room.

##### Example

    <uqlibrary-fbs-booking-form></uqlibrary-fbs-booking-form>

    <script>
      (function () {

        window.addEventListener('polymer-ready', function() {

          var bookingForm = document.querySelector('uqlibrary-fbs-booking-form');

          bookingForm.roomDetails = {
            id:       'abdsfsdf34234234'
            title:     "Group Room 3",
            location:    "Level 3",
            building: "Biological Sciences Library",
            campus:   "St Lucia",
            notes:  "6 chairs, 1 table, PC, Large Screen, whiteboard.",
            image:    "image-thumb.jpg",
            imageLarge:    "image-large.jpg",

            time_span: 30,     //in minutes
            maxtime: 120,    //in minutes
            mintime: 30,    //in minutes

            scheduleid : 'abcd12313123123',
            available_from : 1419429600,
            available_to: 1419516000,

            bookings: [
                      {
                          "id": "sc1547b9f971ca95",
                          "from": 1417647600,
                          "to": 1417654800
                      },
                      {
                          "id": "sc1547b9fbcb4e45",
                          "from": 1417654800,
                          "to": 1417662000
                      },
                      {
                          "id": "sc1547b9fd13d5ef",
                          "from": 1417662000,
                          "to": 1417669200
                      },
                      {
                          "id": "sc1547522d054d86",
                          "from": 1417669200,
                          "to": 1417672800
                      }]
          };

          bookingForm.searchDate = new Date();        //search date and time
          bookingForm.searchDuration = 60;            //in minutes
          bookingForm.maxBookingDate = new Date(new Date().getTime() + 7 * 24 * 60 * 60 * 1000);

          bookingForm.authTokenValue = 'abcd1234';
        });

      }());
    </script>

@element uqlibrary-fbs-booking-form
@blurb Element providing a FBS booking form
@status alpha
@homepage https://github.com/uqlibrary/uqlibrary-fbs-booking-form
-->

<polymer-element name="uqlibrary-fbs-booking-form" attributes="roomDetails searchDate searchDuration maxBookingDate authTokenValue">

<template>
  <link rel="stylesheet" href="uqlibrary-fbs-booking-form.css">

  <div class="roomDetailsWrapper">

  <core-ajax id="createBookingRequest" url="https://app.library.uq.edu.au/api/booking"
             auto="false" method="POST" contentType="application/json"
             on-core-response="{{ createBookingResponse }}" on-core-error="{{ createBookingError }}" on-core-complete="{{ createBookingComplete }}"></core-ajax>

  <div class="booking-room-header" style="background-image: url('{{ roomDetails.imageLarge }}')">
    <h2>
      {{ roomDetails.title }} <br>
      <small>{{roomDetails | formatLocation }}</small>
    </h2>
  </div>

  <p class="booking-room-summary">{{ roomDetails.notes }}</p>

  <uqlibrary-date-selector searchDate="{{ searchDate }}"
                           searchDuration="{{ searchDuration }}"
                           maxBookingDate="{{ maxBookingDate }}"
                           bookingTimeslots = "{{ bookingTimeslots }}"
                           maxBookingLength="{{ roomDetails.maxtime / roomDetails.time_span }}">
  </uqlibrary-date-selector>

  <p class="booking-room-hint">Maximum booking duration is {{ roomDetails.maxtime }} min, minimum booking duration is {{ roomDetails.mintime }} min</p>
  <p class="booking-room-hint">
    <span class="hint-box selected"></span> - your current selection
    <span class="hint-box available"></span> - available time slot
    <span class="hint-box unavailable"></span> - unavailable time slot
  </p>

  <div class="buttonWrapper" horizontal layout hidden?={{transitioning}}>
    <paper-toast id="infoToast" flex></paper-toast>
    <div flex>&nbsp;</div>
    <paper-button id="createRoomBooking" end-justified  icon="done" on-click="{{createRoomBooking}}">Save booking</paper-button>
  </div>

  </div>


</template>

<script>
(function() {
  Polymer('uqlibrary-fbs-booking-form', {
    /**
     * The `roomDetails` attribute object contains properties of the room
     *
     * @property roomDetails
     * @type object
     */

    /** The `searchDate` attribute represents search date/time value
     *
     * @property searchDate
     * @type Date
     *
     */

    /** The `maxBookingDate` attribute represents maximum valid booking day (eg can book up to a week in advance)
     *
     * @property maxBookingDate
     * @type Date
     *
     */

    /** The `searchDuration` attribute represents booking duration value in minutes
     *
     * @property searchDuration
     * @type Int
     *
     */

    /** The `authTokenValue` value of authentication token
     *
     * @property authTokenValue
     * @type String
     *
     */


    /** Fired when booking was successfully created
     *
     * @event booking-created
     *
     */

    /** Fired when search date was changed on the booking form
     *
     * @event booking-date-changed
     *
     */
    roomDetailsChanged : function (oldValue, newValue) {
      this.bookingTimeslots = this.createTimeslots();
      this.selectTimeslots();
    },

    searchDateChanged : function (oldValue, newValue) {
      if (this.searchDate.toDateString() != moment(this.roomDetails.available_from, "X").toDate().toDateString()) {
        this.fire('booking-date-changed', {searchDate: this.searchDate});
      }
    },

    created: function () {
      this.roomDetails = {};
      this.searchDate = new Date();
      this.searchDuration = 90;
      this.maxBookingDate = new Date();
      this.bookingTimeslots = [];

      //TODO: session management, if token is not set - disable interactions
      this.authTokenValue = '';
    },

    ready: function () {
      this.addEventListener('submit-form', this.createRoomBooking);
    },

    showInfoToast: function(text) {
      this.$.infoToast.text = text;
      this.$.infoToast.show();
    },

    validateSelection : function(selectedTimeslots) {
      var validation = {
        valid : true,
        message: ''
      };

      if (selectedTimeslots.length == 0) {
        validation.valid = false;
        validation.message = "Please, make a valid selection.";
      } else if (selectedTimeslots.length > this.maxtime / this.roomDetails.time_span) {
        validation.valid = false;
        validation.message = "Current selection exceeds maximum booking duration. Please, make a valid selection.";
      }
      else if (!selectedTimeslots.every(function(element, index) {
                return !(index < selectedTimeslots.length - 1 && element.endTime.valueOf() !== selectedTimeslots[index+1].startTime.valueOf());
              })) {
        validation.valid = false;
        validation.message = "Current selection is not available. Please, make another selection.";
      }

      return validation;
    },

    createBookingComplete : function(event, object, sender){
      if (object.response != 200) {
        //display error returned by the server
        this.showInfoToast("Error creating a booking: " + object.xhr.responseText);

      } else {
        //if booking is successful, fire event to indicate booking is done and move on to other page
        this.fire('booking-created');
      }
    },

    createRoomBooking : function () {
      // get currently selected elements
      var selectedTimeslots = this.bookingTimeslots.filter(function(item) { return item.selected; });
      var validation = this.validateSelection(selectedTimeslots);

      if (!validation.valid){
        this.showInfoToast(validation.message);
      } else {

        var midnight = new Date(selectedTimeslots[0].startTime.getFullYear(), selectedTimeslots[0].startTime.getMonth(), selectedTimeslots[0].startTime.getDate(), 0, 0, 0);
        var startTime = (selectedTimeslots[0].startTime - midnight) / (1000 * 60);
        var endTime = (selectedTimeslots[selectedTimeslots.length-1].endTime - midnight) / (1000 * 60);

        var newBooking = {
          machid	: this.roomDetails.id,
          scheduleid : this.roomDetails.scheduleid,
          date : moment(selectedTimeslots[0].startTime).format("MM/DD/YYYY"),
          starttime : startTime,
          endtime : endTime
        };

        this.$.createBookingRequest.headers = { 'X-Uql-Token' : this.authTokenValue };
        this.$.createBookingRequest.body = JSON.stringify(newBooking);

        this.$.createBookingRequest.go();
      }
    },

    formatLocation : function (roomDetails) {
      var location = [];

      if (roomDetails.location)
        location.push(roomDetails.location);

      if (roomDetails.building)
        location.push(roomDetails.building);

      if (roomDetails)
        location.push(roomDetails.campus);

      return location.join(", ");
    },

    selectTimeslots : function() {
      var duration = parseInt(Math.min(this.roomDetails.maxtime, this.searchDuration)/this.roomDetails.time_span);
      var remainingDuration = duration;
      var searchDate = this.searchDate;

      this.bookingTimeslots.every(function(element, index) {

        if (element.selectable
                && ((searchDate >= element.startTime && searchDate < element.endTime) || remainingDuration < duration)) {
          element.selected = true;
          remainingDuration--;
        }

        //cannot break selection if there's an unavailable time slot
        return remainingDuration === duration
        || (remainingDuration > 0 && remainingDuration < duration && element.selectable);
      });
    },

    createTimeslots : function() {

      var openingHours = moment(this.roomDetails.available_from, "X");
      var closingHours = moment(this.roomDetails.available_to, "X");
      var workingTimeslots = (closingHours - openingHours) / this.roomDetails.time_span / 60 / 1000;

      var currentDate = moment(new Date(openingHours.toDate()));
      var timeslots = [];

      for (var index = 0; index < workingTimeslots; index++){
        var timeslotStartTime = new Date(currentDate.toDate());
        var timeslotEndTime = new Date(currentDate.add(this.roomDetails.time_span, "m").toDate());

        var selectable = this.roomDetails.bookings.every(function(element, index, array){
          var bookingStartTime = moment(element.from, "X");
          var bookingEndTime = moment(element.to, "X");

          //timeslot does not overlap with existing booking
          if (bookingStartTime >= timeslotEndTime || bookingEndTime <= timeslotStartTime)
            return true;

          //timeslot overlaps with existing booking
          if ((timeslotStartTime >= bookingStartTime && timeslotEndTime <= bookingEndTime)
                  || (timeslotStartTime <= bookingStartTime && timeslotEndTime > bookingStartTime && timeslotEndTime < bookingEndTime)
                  || (timeslotStartTime > bookingStartTime && timeslotStartTime < bookingEndTime && timeslotEndTime >= bookingEndTime))
          {
            return false;
          }
        });

        timeslots.push(
                {
                  startTime: timeslotStartTime,
                  endTime: timeslotEndTime,
                  selected: false,
                  selectable: selectable
                });
      }

      return timeslots;
    }

  });
})();
</script>

</polymer-element>
