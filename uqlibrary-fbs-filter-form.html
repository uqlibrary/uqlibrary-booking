<link rel="import" href="../uqlibrary-elements/0.5.4/lib/vulcanized.html">
<link rel="import" href="uqlibrary-filter-group.html">

<!--
Element providing solution to no problem in particular.

##### Example

    <uqlibrary-fbs-filter-form></uqlibrary-fbs-filter-form>

@element uqlibrary-fbs-filter-form
@blurb Element providing form for filtering rooms.
@status alpha
@homepage https://github.com/uqlibrary/uqlibrary-fbs-filter-form
-->
<polymer-element name="uqlibrary-fbs-filter-form" attributes="formData selectedValues">

  <template>
    <style>
      :host {
        font-size: 10pt;
        width: 100%;
      }
    </style>
    <core-signals on-core-signal-transition-prepare="{{transitionPrepareHandler}}"></core-signals>
    <core-signals on-core-signal-transition-end="{{transitionEndHandler}}"></core-signals>

    <link rel="stylesheet" href="../uqlibrary-elements/resources/theme/element.css" shim-shadowdom />

        <div id="filterWrapper" class="filterWrapper">
          <div class="filterForm">


            <!-- hidden groups -->

            <uqlibrary-filter-group label="Equipment" icon="settings" hidden>
              <div class="equipment-item" layout horizontal>
                <core-label flex for="#equipment_pc">
                  <core-icon icon="hardware:desktop-windows"></core-icon>
                  PC
                </core-label>
                <paper-checkbox id="equipment_pc" on-core-change="{{checkboxToggle}}" checked?="{{selectedEquipment.pc}}"></paper-checkbox>
              </div>

              <div class="equipment-item" layout horizontal>
                <core-label flex for="#equipment_projector">
                  <core-icon icon="av:videocam"></core-icon>
                  Projector
                </core-label>
                <paper-checkbox id="equipment_projector" on-core-change="{{checkboxToggle}}" checked?="{{selectedEquipment.projector}}"></paper-checkbox>

              </div>
            </uqlibrary-filter-group>
            <!-- end hidden groups -->

            <uqlibrary-filter-group label="Campus" icon="communication:location-on">
                <paper-dropdown-menu id="campusSelect" label="{{errors.campus ? errors.campus : 'Campus'}}" class="{{errors.campus ? 'error' : ''}}" disabled?="{{!campuses.length}}" aria-label="expand list of campuses">
                  <paper-dropdown class="dropdown">
                    <core-menu class="menu" id="campusSelectMenu" selectedAttribute="" selected="{{selectedCampus}}">
                      <template repeat="{{campuses as item}}">
                        <paper-item name="{{item.id}}" label="{{item.title}}">
                          <uqlibrary-a11y-link>
                            {{item.title}}
                          </uqlibrary-a11y-link>
                        </paper-item>
                      </template>
                    </core-menu>
                  </paper-dropdown>
                </paper-dropdown-menu>

                <paper-dropdown-menu id="buildingSelect" label="Building" aria-label="select building in campus {{selectedCampus}}" aria-hidden="{{!buildings.length}}" hidden?="{{!buildings.length}}">
                  <paper-dropdown class="dropdown">
                    <core-menu class="menu" id="buildingSelectMenu" selectedAttribute="" selected="{{selectedBuilding}}">
                      <paper-item name="" aria-hidden="{{buildings.length <= 1}}" hidden?="{{buildings.length <= 1}}" label="">Any building</paper-item>
                      <template repeat="{{building in buildings}}">
                        <paper-item name="{{building.id}}" label="{{building.title}}">
                          <uqlibrary-a11y-link>
                            {{building.title}}
                          </uqlibrary-a11y-link>
                        </paper-item>
                      </template>
                    </core-menu>
                  </paper-dropdown>
                </paper-dropdown-menu>

                <paper-dropdown-menu id="roomSelect" label="Room" aria-label="select room in building {{selectedBuilding}}" aria-hidden="{{!rooms.length}}" hidden?="{{!rooms.length}}">
                  <paper-dropdown class="dropdown">
                    <core-menu class="menu"  id="roomSelectMenu" selectedAttribute="" selected="{{selectedRoom}}">
                      <paper-item name=""  hidden?="{{rooms.length <= 1}}" label="">Any room</paper-item>
                      <template repeat="{{rooms as room}}">
                        <paper-item name="{{room.id}}" label="{{room.title}}">
                          <uqlibrary-a11y-link>
                            {{room.title}}
                          </uqlibrary-a11y-link>
                        </paper-item>
                      </template>
                    </core-menu>
                  </paper-dropdown>
                </paper-dropdown-menu>
            </uqlibrary-filter-group>

            <uqlibrary-filter-group label="Time" icon="device:access-time">
              <paper-dropdown-menu id="dateSelect" label="Today" aria-label="Booking date">
                <paper-dropdown class="dropdown">
                  <core-menu class="menu" valueattr="value" selectedAttribute="" selected="{{selectedDate}}">
                    <template repeat="{{dates as date}}">
                      <paper-item value="{{date.value}}" label="{{date.text}}">
                        <uqlibrary-a11y-link>
                          {{date.text}}
                        </uqlibrary-a11y-link>
                      </paper-item>
                    </template>
                  </core-menu>
                </paper-dropdown>
              </paper-dropdown-menu>

              <paper-input-decorator id="decorator" on-down="{{showTimepicker}}" label="Start time" floatingLabel>
                <input id="time" readonly  value="{{selectedTime}}" label="Start time" floatingLabel>
              </paper-input-decorator>

              <core-overlay id="timepickerDialog" transition="core-transition-center" autoCloseDisabled
                on-core-overlay-open-completed="{{timepickerOpenCompletedHandler}}"
                on-core-overlay-close-completed="{{timepickerCloseCompletedHandler}}">
                  <md-timepicker id="timepicker" timeFormat="{{timeFormat}}" on-time-selected="{{timeSelectedHandler}}"></md-timepicker>
              </core-overlay>

              <div class="sliderWrapper" layout horizontal justified center>
                <div id="durationLabel">Duration</div>
                <paper-slider aria-label="booking duration" flex id="timePeriod" pin snaps step="30" aria-valuetext="{{durationImmidiate}} minutes" min="30" max="120" immediateValue="{{durationImmidiate}}" value="{{selectedDuration}}"></paper-slider>
                <div end-justified class="durationText">{{durationImmidiate}} minutes</div>
              </div>

            </uqlibrary-filter-group>
            <uqlibrary-filter-group label="Capacity" icon="social:people">
              <div class="sliderWrapper" layout horizontal justified center>
                <div id="capacityLabel">Number of people</div>
                <paper-slider aria-label="room capacity" flex editable pin snaps step="1" aria-valuetext="{{selectedCapacity}} people" min="1" max="25" value="{{selectedCapacity}}"></paper-slider>
              </div>
            </uqlibrary-filter-group>

          </div>

          <uqlibrary-persistent-footer id="persistentFooter">
            <div flex class="footerInfo">{{resultsText}}</div>
          </uqlibrary-persistent-footer>

         <paper-toast id="infoToast"></paper-toast>
      </div>
    <content></content>

  </template>

  <script type="text/javascript">


    Polymer('uqlibrary-fbs-filter-form', {


      publish: {
        selectedValues: {
          value: {}
        }
      },

      observe: {
        'formData.facilities': 'facilitiesChanged',
        'formData.dates': 'initialDatesChanged',
        'formData.rooms': 'roomsDataChanged',
        selectedValues: 'selectedValuesChanged',
        selectedCapacity: 'triggerSelectedValuesChange',
        selectedDuration: 'triggerSelectedValuesChange'
      },

      campuses: [],
      buildings:[],
      rooms:[],
      dates:[],
      formData: {
        facilities: [],
        dates: []
      },
      transitioning: false,

      selectedCampus: '',
      selectedBuilding: '',
      selectedRoom: '',
      selectedDate: '',
      timeFormat: '12h',
      timeOutputFormat: 'hh:mm a',
      selectedTime: '',
      selectedEquipment: {},
      timepickerOpened: false,

      errors: {},
      resultsText: '',

      refreshList: '',
      months: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
      dayNames: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'],

      created: function() {

      },

      ready: function() {
        this.addEventListener('submit-form', this.submitForm);
        this.addEventListener('results-changed', this.resultsChanged);
        this.selectedTime = moment().format(this.timeOutputFormat);

        this.$.persistentFooter.actionButtons = [{title: 'Search', id: 'submitFormButton', class:'colored'}];
        this.addEventListener('uqlibrary-persistent-footer-action-button-clicked', function(e) {
          if(e.detail.button && e.detail.button.id == 'submitFormButton') {
            this.submitForm();
          }
        });

        var that = this;
        document.addEventListener('click', function(e) {
          if(that.timepickerOpened) {
            that.$.timepickerDialog.toggle();
          }
        });
        this.$.timepickerDialog.addEventListener('click', function(e) {
          e.stopPropagation();
        });
      },

      triggerSelectedValuesChange: function() {
        this.getSelectedValues();
        this.fire('selected-values-changed', {formData: this.selectedValues});
      },

      submitForm: function() {
        this.getSelectedValues();
        if(this.validateForm()) {
          this.fire('filter-form-submitted', {formData: this.selectedValues});
        }
      },

      showInfoToast: function(text) {
        this.$.infoToast.text = text;
        this.$.infoToast.show();
      },

      facilitiesChanged: function(oldValue, newValue) {
        this.campuses = [];
        this.buildings = [];
        this.rooms = [];

        if(this.formData.facilities) {
          this.loadCampuses();
          this.loadBuildings();
          this.loadRooms();
        }
      },

      validateForm: function() {
        this.errors = {};
        var isValid = true;

        if(!this.selectedCampus) {
          this.errors['campus'] = 'Select campus';
          isValid = false;
          this.$.campusSelect.focus();
        }
        return isValid;
      },


      initialDatesChanged: function(oldValue, newValue) {
        this.dates = [];
        for (var i = 0; i < this.formData.dates.length; i++) {
          var _date = this.formData.dates[i];

          _date.date = new Date(_date.date);
          _date.day = _date.date.getDate();
          _date.value = _date.date; //_date.day+'/'+(_date.date.getMonth() + 1)+'/'+_date.date.getFullYear();
          _date.text = ( _date.day == new Date().getDate() ? 'Today' :  this.dayNames[_date.date.getDay()] + ', ' + this.months[_date.date.getMonth()] + ' ' + _date.day);

          this.dates.push(_date);
        }
        this.selectedDate = this.dates[0].value;

      },

      loadCampuses: function() {
        this.campuses = [];
        for(var i = 0; i < this.formData.facilities.length; i++) {
          var _campus = this.formData.facilities[i];
          this.campuses.push(
            { "id": _campus.id,
              "title": _campus.title
            }
          );
        }
      },

      loadBuildings: function() {
        this.buildings = [];
        for(var i = 0; i < this.formData.facilities.length; i++) {
          var _campus = this.formData.facilities[i];
          if(this.selectedCampus && this.selectedCampus == _campus.id ){
            for(var j = 0; j < _campus.buildings.length; j++) {
              var _building = _campus.buildings[j];
              this.buildings.push(
                { "id": _building.id,
                  "title": _building.title
                }
              );
            }
            if (this.buildings.length == 1) {
              this.selectedBuilding = this.buildings[0].id;
            } else {
              if (this.buildings.length > 1) {
                this.rooms = [];
              }
            }
          }
        }
        var el = document.querySelector("paper-dropdown-menu#buildingSelect paper-dropdown /deep/ #scroller");
        if (el) {
          el.style.width = null;
          el.style.height = null;
        }


      },

      loadRooms: function() {
        this.rooms = [];
        for(var i = 0; i < this.formData.facilities.length; i++) {
          var _campus = this.formData.facilities[i];
          if(this.selectedCampus && this.selectedCampus == _campus.id ){
            for(var j = 0; j < _campus.buildings.length; j++) {
              var _building = _campus.buildings[j];
              if(this.selectedBuilding && this.selectedBuilding == _building.id) {
                for(var k = 0; k < _building.rooms.length; k++) {
                  var _room = _building.rooms[k];
                  this.rooms.push(
                    { "id": _room.id,
                      "title": _room.title
                    }
                  );
                }
              }
            }

            if(this.rooms.length == 1) {
              this.selectedRoom = this.rooms[0].id;
            }
          }
        }

        var el = document.querySelector("paper-dropdown-menu#roomSelect paper-dropdown /deep/ #scroller");
        if (el) {
          el.style.width = null;
          el.style.height = null;
        }

      },


      selectedCampusChanged: function(oldValue, newValue) {
        if(oldValue != '') {
          this.selectedBuilding = '';
        }
        if (newValue) {
          this.loadBuildings();
        }
        this.triggerSelectedValuesChange();
      },

      selectedBuildingChanged: function(oldValue, newValue) {
        // If user selects a value. Not acceptable to initial form state
        if (oldValue != '') {
          this.selectedRoom = '';
        }

        if (newValue) {
          this.loadRooms();
        }
        // If "any building" option was selected
        if(newValue === 0) {
          this.rooms = [];
          this.selectedBuilding = '';
        }
        this.triggerSelectedValuesChange();
      },

      selectedRoomChanged: function(oldValue, newValue) {
        // If user selects a value. Not acceptable to initial form state
        if (newValue) {
          // As selected index for roomSelect isn't set yet we have to loop through rooms to find selected one and set capacity and min/max booking time
          // If there's a 'Any building' and 'Any Room' options index must be adjusted
          var _buildingIndex = (this.$.buildingSelectMenu.items.length > 1 ? this.$.buildingSelectMenu.selectedIndex-1 :0);
          for(var i = 0; i < this.formData.facilities[this.$.campusSelectMenu.selectedIndex].buildings[_buildingIndex].rooms.length; i++) {
            var _room = this.formData.facilities[this.$.campusSelectMenu.selectedIndex].buildings[_buildingIndex].rooms[i];
            if(_room.id == newValue) {
              if (_room.capacity) {
                this.selectedCapacity = _room.capacity;
              }
              else {
                this.selectedCapacity = 1;
              }
              if (_room.mintime) {
                this.$.timePeriod.min = parseInt(_room.mintime);
              }
              if (_room.maxtime) {
                this.$.timePeriod.max = parseInt(_room.maxtime);
              }
              if (_room.time_span) {
                this.$.timePeriod.step = parseInt(_room.time_span);
              }
              if(this.selectedDuration > this.$.timePeriod.max) {
                this.selectedDuration = this.$.timePeriod.max;
              }
              this.$.timePeriod.update();
              break;
            }
          }
        }
        // If "any room" option was selected
        if(newValue === 0) {
          this.selectedRoom = '';
        }
        this.triggerSelectedValuesChange();
      },

      selectedTimeChanged: function(oldValue, newValue) {
        this.$.decorator.updateLabelVisibility(newValue);
        this.triggerSelectedValuesChange();
      },

      selectedValuesChanged: function() {
        if(this.selectedValues) {
          this.selectedCampus = this.selectedValues.campus;
          this.selectedBuilding = this.selectedValues.building;
          this.selectedRoom = this.selectedValues.room;
          this.selectedDate = this.selectedValues.date;
          this.selectedTime = this.selectedValues.time ? this.selectedValues.time : moment().format(this.timeOutputFormat);
          this.selectedDuration = this.selectedValues.duration;
          this.selectedCapacity = this.selectedValues.capacity;
          this.selectedEquipment = (this.selectedValues.equipment ? this.selectedValues.equipment : {});
        }
        else {
          this.selectedValues = {};
        }

      },

      getSelectedValues: function() {
        this.selectedValues.campus = this.selectedCampus;
        this.selectedValues.building = this.selectedBuilding;
        this.selectedValues.room = this.selectedRoom;
        this.selectedValues.date = this.selectedDate;
        this.selectedValues.time = this.selectedTime;

        if(this.selectedDate ){
          this.selectedValues.searchDate = new Date(this.selectedDate)
        } else {
          this.selectedValues.searchDate = new Date();
        }
        if(this.selectedTime){

          if(this.timeFormat == '12h') {
            this.selectedValues.searchDate.setHours(this.$.timepicker.convertHoursTo24hFormat(this.selectedTime.substring(0,this.selectedTime.indexOf(":"))));
            this.selectedValues.searchDate.setMinutes(this.selectedTime.substring(this.selectedTime.indexOf(":")+1, this.selectedTime.indexOf(" ")));
          }
          else {
            this.selectedValues.searchDate.setHours(this.selectedTime.substring(0,this.selectedTime.indexOf(":")));
            this.selectedValues.searchDate.setMinutes(this.selectedTime.substring(this.selectedTime.indexOf(":")+1));
          }


        } else {
          this.selectedValues.searchDate.setHours(new Date().getHours());
          this.selectedValues.searchDate.setMinutes(new Date().getMinutes());
        }
        this.selectedValues.searchDate.setSeconds(0);

        this.selectedValues.duration = this.selectedDuration;
        this.selectedValues.capacity = this.selectedCapacity;
        this.selectedValues.equipment = this.selectedEquipment;

      },

      selectedDateChanged: function(oldValue, newValue) {
        if(oldValue != ''){
          this.getSelectedValues();
          this.fire('selected-date-changed', {date: newValue, formData: this.selectedValues});
        }
      },

      timeSelectedHandler: function(e, value) {
        this.selectedTime = value.time;
        this.$.timepickerDialog.toggle();
      },

      showTimepicker: function() {
        if(this.selectedTime) {
          this.$.timepicker.hours = this.selectedTime.substring(0,this.selectedTime.indexOf(":"));
          this.$.timepicker.isPm = (this.selectedTime.substring(this.selectedTime.indexOf(" ") + 1) == 'pm');
          if(this.timeFormat == '12h')
            this.$.timepicker.minutes = this.selectedTime.substring(this.selectedTime.indexOf(":")+1, this.selectedTime.indexOf(" "));
          else
            this.$.timepicker.minutes = this.selectedTime.substring(this.selectedTime.indexOf(":")+1);
        }
        this.$.timepicker.selectHours();
        this.$.timepickerDialog.toggle();
      },

      checkboxToggle: function(e, data, sender) {
        var _id = sender.getAttribute('id').replace('equipment_','');
        this.selectedEquipment[_id] = sender.checked;

      },

      transitionPrepareHandler: function() {
        this.transitioning = true;
      },

      transitionEndHandler: function(e) {
        this.transitioning = false;
      },

      setResultsText: function(text) {
          this.resultsText = text;
      },

      timepickerOpenCompletedHandler: function() {
        this.timepickerOpened = true;
      },

      timepickerCloseCompletedHandler: function() {
        this.timepickerOpened = false;
      }
    });

  </script>

</polymer-element>

