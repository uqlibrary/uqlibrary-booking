<link rel="import" href="../uqlibrary-elements/0.5.2/lib/vulcanized.html">

<!--
Element providing a simple booking display.

##### Example

    <uqlibrary-fbs-booking-display></uqlibrary-fbs-booking-display>

    <script>
      (function () {

        window.addEventListener('polymer-ready', function() {

          var element = document.querySelector('uqlibrary-fbs-booking-display');

          bookingForm.bookingDetails = {
            id: "abc123123123",
            startDate: new Date(),
            endDate: new Date(),
            title: "",
            scheduleid: "abcd12313123123",
            machid: "abdsfsdf34234234"
          };

          bookingForm.roomDetails = {
            id:       'abdsfsdf34234234'
            title:     "Group Room 3",
            location:    "Level 3",
            building: "Biological Sciences Library",
            campus:   "St Lucia",
            notes:  "6 chairs, 1 table, PC, Large Screen, whiteboard.",
            image:    "image-thumb.jpg",
            imageLarge:    "image-large.jpg",

            time_span: 30,     //in minutes
            maxtime: 120,    //in minutes
            mintime: 30,    //in minutes

            scheduleid : 'abcd12313123123',
            available_from : 1419429600,
            available_to: 1419516000,

            bookings: [
                      {
                          "id": "sc1547b9f971ca95",
                          "from": 1417647600,
                          "to": 1417654800
                      },
                      {
                          "id": "sc1547b9fbcb4e45",
                          "from": 1417654800,
                          "to": 1417662000
                      },
                      {
                          "id": "sc1547b9fd13d5ef",
                          "from": 1417662000,
                          "to": 1417669200
                      },
                      {
                          "id": "sc1547522d054d86",
                          "from": 1417669200,
                          "to": 1417672800
                      }]
          };

          bookingForm.searchDate = new Date();        //search date and time
          bookingForm.searchDuration = 60;            //in minutes
          bookingForm.maxBookingDate = new Date(new Date().getTime() + 7 * 24 * 60 * 60 * 1000);
        });

          element.roomDetails = {
            id:       1
            room:     "Group Room 3",
            level:    "Level 3",
            building: "Biological Sciences Library",
            campus:   "St Lucia",
            summary:  "6 chairs, 1 table, PC, Large Screen, whiteboard.",
            image:    "image-thumb.jpg",
            imageLarge:    "image-large.jpg",

            timeslotLength: 30,     //in minutes
            maxBookingLength: 120,  //in minutes
            minBookingLength: 30    //in minutes
          };

          element.bookingDetails = {
            id: 1,
            startdate: new Date().setHours(0, 0, 0, 0),
            endDate: new Date().setHours(1, 30, 0, 0),
            title: "Group Room 3",
            subtitle: "Level 3, Biological Sciences Library, St Lucia"
          };
        });

      }());
    </script>

@element uqlibrary-fbs-booking-display
@blurb Element providing a FBS booking display
@status alpha
@homepage https://github.com/uqlibrary/uqlibrary-fbs-booking-display
-->

<polymer-element name="uqlibrary-fbs-booking-display" attributes="roomDetails bookingDetails authTokenValue">

  <template>
    <link rel="stylesheet" href="uqlibrary-fbs-booking-form.css">

    <core-signals on-core-signal-transition-prepare="{{transitionPrepareHandler}}"></core-signals>
    <core-signals on-core-signal-transition-end="{{transitionEndHandler}}"></core-signals>

    <uqlibrary-api-facilities-booking id="deleteBookingRequest" on-uqlibrary-api-facilities-booking-executed="{{ deleteBookingComplete }}"></uqlibrary-api-facilities-booking>

    <core-ajax id="deleteBookingRequest2" url="https://app.library.uq.edu.au/api/booking"
               auto="false" method="DELETE" contentType="application/json"
               on-core-response="{{ deleteBookingResponse }}" on-core-error="{{ deleteBookingError }}" on-core-complete="{{ deleteBookingComplete }}"></core-ajax>

    <div class="display-section">

      <div class="booking-room-header" style="background-image: url('https://app.library.uq.edu.au/assets/images/uq-buildings/{{ roomDetails.imageLarge }}')">
        <h2>
          {{ roomDetails.title }} <br>
          <small>{{roomDetails | formatLocation }}</small>
        </h2>
      </div>

      <div class="booking-details-item" horizontal layout>
        <div>
          <core-icon icon="today" class="big-icon"></core-icon>
        </div>
        <div flex>
          <h3>Date</h3>
          <p>{{bookingDetails | formatBookingDate }}</p>
        </div>
      </div>

      <div class="booking-details-item" horizontal layout>
        <div>
          <core-icon icon="schedule" class="big-icon"></core-icon>
        </div>
        <div flex>
          <h3>Time</h3>
          <p>{{bookingDetails | formatBookingTime}}</p>
        </div>
      </div>

      <div class="booking-details-item" horizontal layout>
        <div>
          <core-icon icon="description" class="big-icon"></core-icon>
        </div>
        <div flex>
          <h3>Room Details</h3>
          <p>{{roomDetails.notes}}</p>
        </div>
      </div>

      <div class="booking-details-item" horizontal layout hidden?="{{!roomDetails.url}}">
        <div>
          <core-icon icon="file-map" class="big-icon"></core-icon>
        </div>
        <div flex>
          <h3>Map</h3>
          <p><a href="{{roomDetails.url}}}">View map</a></p>
        </div>
      </div>

      <paper-dialog backdrop autoCloseDisabled id="infoDialog" role="dialog">
        <p>Delete this booking?</p>
        <paper-button affirmative on-tap="{{toggleDeleteDialog}}">Cancel</paper-button>
        <paper-button affirmative autofocus on-tap="{{deleteBooking}}">Delete</paper-button>
      </paper-dialog>


    <uqlibrary-persistent-footer id="persistentFooter"></uqlibrary-persistent-footer>
    <paper-toast id="infoToast" flex></paper-toast>

  </template>

  <script>
    (function() {
      Polymer('uqlibrary-fbs-booking-display', {
        /**
         * The `roomDetails` attribute object contains properties of the room
         *
         * @property roomDetails
         * @type object
         */

        /** The `bookingDetails` attribute object represents booking details, eg resid, start date, end date, etc
         *
         * @property bookingDetails
         * @type object
         *
         */

        created: function () {
          this.roomDetails = {};
          this.bookingDetails = {};
        },

        ready: function () {

          this.$.persistentFooter.actionButtons = [{title: 'Delete Booking', id: 'toggleDeleteDialog'}];

          this.addEventListener('uqlibrary-persistent-footer-action-button-clicked', function(e) {
            if(e.detail.button && e.detail.button.id == 'toggleDeleteDialog') {
              this.toggleDeleteDialog();
            }
          });
        },

        transitionPrepareHandler: function() {
          this.transitioning = true;
        },

        transitionEndHandler: function() {
          this.transitioning = false;
        },

        formatLocation : function (roomDetails) {
          var location = [];

          if (roomDetails.location !== undefined)
            location.push(roomDetails.location);

          if (roomDetails.building !== undefined)
            location.push(roomDetails.building);

          if (roomDetails !== undefined)
            location.push(roomDetails.campus);

          return location.join(", ");
        },

        formatBookingTime : function(bookingDetails) {
          var startFormat = moment(bookingDetails.startDate).format('a') == moment(bookingDetails.endDate).format('a') ? 'h:mm' : 'h:mm a';
          return moment(bookingDetails.startDate).format(startFormat) + " - " + moment(bookingDetails.endDate).format('h:mm a');
        },

        formatBookingDate : function(bookingDetails) {
          return moment(bookingDetails.startDate).format('dddd MMMM D, YYYY');
        },

        toggleDeleteDialog: function () {
          this.$.infoDialog.toggle();
        },

        showInfoToast: function(text) {
          this.$.infoToast.text = text;
          this.$.infoToast.show();
        },

        deleteBookingComplete : function(event){
          if (event.detail.response) {
            //display error returned by the server
            this.showInfoToast("Error deleting this booking: " + event.detail.responseText);

          } else {
            //if booking delete is successful, fire event to indicate booking delete is done and move on to other page
            this.fire('booking-deleted');
          }
        },

        deleteBooking : function () {
          this.toggleDeleteDialog();

          var deleteBooking = { booking : {
              resid: this.bookingDetails.id
            }
          };

          this.$.deleteBookingRequest.delete(deleteBooking);
        }
      });
    })();
  </script>

</polymer-element>
